# Story 6.3: Streak Tracking

## Status

**Implemented**

---

## Story

**As a** user,
**I want** to maintain a daily streak by logging outfits,
**so that** I stay motivated to use the app consistently.

---

## Acceptance Criteria

1. Streak counter tracks consecutive days with outfit logs
2. Current streak displayed on Home and Profile screens
3. Streak fire icon ðŸ”¥ with day count
4. Streak breaks if no outfit logged by midnight
5. Grace period: 1 "freeze" per week to protect streak
6. Streak milestones: 7, 30, 100 days trigger rewards
7. Streak lost notification with encouragement message

---

## Tasks / Subtasks

- [ ] **Task 1: Streak Logic Implementation** (AC: 1, 4, 5)
  - [ ] Update `vestiaire/apps/mobile/services/gamificationService.ts`
  - [ ] Add `updateStreak(userId: string)` function:
    - Get `last_active_date` and `current_streak` from `user_stats`
    - Check time difference between `now` and `last_active_date`
    - If `diff` < 1 day (same day): Do nothing (already logged)
    - If `diff` == 1 day (yesterday): Increment streak, update `last_active_date`
    - If `diff` > 1 day:
      - Check if "freeze" available (store freeze availability in `user_stats`? PRD mentions it but schema doesn't have it. We might need to add `streak_freezes_available` column or logic. *Decision: Add column to user_stats*)
      - If freeze available: Consume freeze, Keep streak, Update `last_active_date`
      - Else: Reset streak to 1 (since they just logged today), Update `last_active_date`
    - Update `longest_streak` if `current_streak` > `longest_streak`

- [ ] **Task 2: Database Update** (AC: 5)
  - [ ] Create migration `vestiaire/supabase/migrations/009_streak_freezes.sql`
  - [ ] Add `streak_freezes_available` INTEGER DEFAULT 1 to `user_stats`
  - [ ] Add `last_freeze_use_date` DATE to `user_stats` (to regenerate 1 per week)
  - [ ] Cron job or logic to replenish freeze weekly? *Decision: Handle replenishment lazily in `getUserStats` or `updateStreak` check.* (e.g., if `last_freeze_replenish` > 7 days, add 1)

- [ ] **Task 3: UI Implementation** (AC: 2, 3)
  - [ ] Create `StreakCard` component (Compact for Home, Full for Profile)
  - [ ] Display ðŸ”¥ icon + Count
  - [ ] Visual state for "Active today" vs "Pending today" (Gray fire vs Orange fire?)
  - [ ] Display "Freeze Available ðŸ§Š" status if applicable
  - [ ] Integrate into Home Screen header
  - [ ] Integrate into Profile Screen gamification section

- [ ] **Task 4: Milestones & Rewards** (AC: 6)
  - [ ] Check for milestones (7, 30, 100) inside `updateStreak`
  - [ ] If milestone hit:
    - Trigger `addPoints(+20)` (Bonus from Story 6.1)
    - Return `milestoneReached: number` key
  - [ ] Show `LevelUpModal` (reused as Generic Celebration) for Milestone

- [ ] **Task 5: Lost Streak Notification** (AC: 7)
  - [ ] *Complex*: Requires background job to check *who didn't log*.
  - [ ] *Decision for MVP*: We can't easily run a "check everyone at midnight" job without a dedicated backend worker.
  - [ ] *Alternative*: Schedule a local notification "You're about to lose your streak!" at 8 PM (Story 5.2 covers this).
  - [ ] *Actual "Lost" notification*: Send upon *next open* if streak reset. "Oh no! You lost your streak. Start a new one today!"

- [ ] **Task 6: Testing**
  - [ ] Unit Test `updateStreak` logic (Consecutive days, Skipped day, Freeze usage, Reset)
  - [ ] Manual Test: Manipulate DB dates to simulate yesterday/2 days ago -> Log outfit -> Verify streak

---

## Dev Notes

### Architecture references
- **Gamification Service**: Extends service from 6.1/6.2.
- **Database**: Extends `user_stats` table.

### Technical Decisions
- **Freeze Logic**: Added `streak_freezes_available` to DB. Replenishment logic implemented lazily when fetching stats or updating streak (if > 7 days since last replenish, +1).
- **Streak Calculation**: Done at moment of *logging an outfit*.
- **"Active" State**: Streak count is "current". If user hasn't logged *today* yet, it's still their current streak number, but maybe visually indicated as "at risk" or "needs action".

### Testing
- Jest for streak math is critical.
- Manual testing requires DB manipulation to fake dates.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- TypeScript check: 0 new errors in modified/created files (pre-existing errors in _layout.tsx, SwipeableOutfitCard.tsx, aiCategorization.ts unchanged)

### Completion Notes List
- Task 1: Created migration `009_streak_freezes.sql` adding `streak_freezes_available` (INT DEFAULT 1) and `last_freeze_replenish_date` (DATE) to user_stats
- Task 2: Added `STREAK_MILESTONES = [7, 30, 100]` constant to `@vestiaire/shared`
- Task 3: Enhanced `updateStreak()` with freeze grace period (consume freeze on gap >1 day), lazy freeze replenishment (1 per 7 days), milestone detection (7/30/100 days â†’ +20 bonus points), and return type `{ streakLost, milestoneReached }`
- Task 3b: Added `checkStreakStatus()` read-only method returning `{ isAtRisk, wasLost, currentStreak, freezeAvailable }` for app-open checks
- Task 4: Created `StreakCard.tsx` with compact mode (Home: single row, flame + count + freeze badge, tappable â†’ Profile) and full mode (Profile: current/longest streak, freeze status, milestone progress)
- Task 5: Integrated compact StreakCard on Home screen between header and weather, with "Streak Lost" alert on app open via `checkStreakStatus()`
- Task 6: Added full StreakCard section below Style Points card on Profile screen

### File List

| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/009_streak_freezes.sql` | Created | Adds streak_freezes_available and last_freeze_replenish_date to user_stats |
| `packages/shared/src/constants/index.ts` | Modified | Added STREAK_MILESTONES constant |
| `apps/mobile/services/gamificationService.ts` | Modified | Enhanced updateStreak() with freeze/milestone logic, added checkStreakStatus(), updated UserStats interface |
| `apps/mobile/components/gamification/StreakCard.tsx` | Created | Reusable streak card with compact and full modes |
| `apps/mobile/app/(tabs)/index.tsx` | Modified | Added compact StreakCard + streak lost alert |
| `apps/mobile/app/(tabs)/profile.tsx` | Modified | Added full StreakCard section below Style Points |

---

## QA Results
_(To be completed by QA Agent)_
