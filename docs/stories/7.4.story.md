# Story 7.4: Listing History Tracking

## Status

**Done**

---

## Story

**As a** user,  
**I want** to track items I've created listings for,  
**so that** I can manage my resale activity.

---

## Acceptance Criteria

1. "Listings Created" section in Analytics or Profile
2. Shows: item photo, listing text preview, date created
3. Status tracking: Listed, Sold, Cancelled
4. Mark as "Sold" removes item from active wardrobe
5. Sold items tracked for lifetime stats (revenue, items sold)
6. Re-generate listing option for unsold items
7. Filter by status (All, Listed, Sold, Cancelled)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Listings Database Schema** (AC: 1, 2, 3)
  - [ ] Create migration `013_resale_listings.sql`
  - [ ] Create `resale_listings` table with: id, user_id, item_id, title, description, category, condition, status, created_at, sold_at
  - [ ] Add RLS policies for user access
  - [ ] Add index on (user_id, status)

- [ ] **Task 2: Update Listing Service** (AC: 1, 2, 6)
  - [ ] Add `saveListingToHistory()` method to listingService
  - [ ] Add `getListingHistory()` method
  - [ ] Add `regenerateListing(listingId)` method
  - [ ] Store listing when generated

- [ ] **Task 3: Create Listing History Screen** (AC: 1, 2, 7)
  - [ ] Create `app/(tabs)/listing-history.tsx` screen
  - [ ] Add navigation from Analytics or Profile
  - [ ] Display list of listings with item thumbnails
  - [ ] Show status badges (Listed/Sold/Cancelled)
  - [ ] Add filter chips for status

- [ ] **Task 4: Implement Status Management** (AC: 3, 4)
  - [ ] Add status dropdown/buttons on each listing card
  - [ ] Implement "Mark as Sold" action
  - [ ] Confirmation dialog before marking sold
  - [ ] Update item status in wardrobe (archive/hide)

- [ ] **Task 5: Track Sold Items Stats** (AC: 5)
  - [ ] Add `total_items_sold` and `total_revenue` to user stats
  - [ ] Update stats when item marked as sold
  - [ ] Display stats on Analytics dashboard

- [ ] **Task 6: Re-generate Listing** (AC: 6)
  - [ ] Add "Re-generate" button on unsold listings
  - [ ] Call Gemini to create new listing text
  - [ ] Update listing record with new text

- [ ] **Task 7: Testing**
  - [ ] Test listing creation and storage
  - [ ] Test status updates
  - [ ] Test sold item removal from wardrobe
  - [ ] Test re-generation

---

## Dev Notes

### Database Schema

```sql
CREATE TABLE resale_listings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    item_id UUID REFERENCES items(id) ON DELETE CASCADE NOT NULL,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    category TEXT,
    condition TEXT,
    status TEXT DEFAULT 'listed' CHECK (status IN ('listed', 'sold', 'cancelled')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    sold_at TIMESTAMPTZ,
    sold_price NUMERIC(10, 2)
);

CREATE INDEX resale_listings_user_status_idx ON resale_listings(user_id, status);
```

### Status Flow

```
Draft â†’ Listed â†’ Sold
              â†˜ Cancelled
```

### UI Components

**Listing Card:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [img] Navy Coat - Size M       ğŸŸ¢   â”‚
â”‚       Created: Feb 5, 2026          â”‚
â”‚       Status: Listed                â”‚
â”‚       [View] [Mark Sold] [Cancel]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Locations

| File | Path |
|------|------|
| Migration | `supabase/migrations/013_resale_listings.sql` |
| Listing Service | `apps/mobile/services/listingService.ts` |
| History Screen | `apps/mobile/app/(tabs)/listing-history.tsx` |
| Types | `apps/mobile/types/listing.ts` |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- TS check: 0 new errors (5 pre-existing in `_layout.tsx`, `SwipeableOutfitCard.tsx`, `aiCategorization.ts`)

### Completion Notes List
1. Created `resale_listings` table with status tracking (listed/sold/cancelled), RLS policies, indexes
2. Added `total_items_sold` and `total_revenue` columns to `user_stats`
3. Extended `listingService` with history methods: `saveToHistory`, `getHistory`, `updateStatus`, `getResaleStats`
4. Created `listing-history.tsx` screen with stats row, status filter chips, listing cards with actions
5. "Mark as Sold" flow with sold price input modal, updates user_stats revenue
6. "Re-generate" button opens ListingGeneratorModal for unsold items
7. "Cancel" button with confirmation dialog
8. Auto-save to listing history when generating from ListingGeneratorModal
9. Navigation: Analytics screen "My Listings" card + Profile menu "My Listings" item
10. Registered route in `_layout.tsx` as hidden tab

### File List

| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/013_resale_listings.sql` | Created | resale_listings table, RLS, indexes, user_stats columns |
| `apps/mobile/services/listingService.ts` | Modified | Added ResaleListing type, saveToHistory, getHistory, updateStatus, getResaleStats |
| `apps/mobile/app/(tabs)/listing-history.tsx` | Created | Listing history screen with stats, filters, cards, sold modal |
| `apps/mobile/app/(tabs)/_layout.tsx` | Modified | Registered listing-history as hidden route |
| `apps/mobile/app/(tabs)/analytics.tsx` | Modified | Added "My Listings" navigation card |
| `apps/mobile/app/(tabs)/profile.tsx` | Modified | Added "My Listings" menu item |
| `apps/mobile/components/features/ListingGeneratorModal.tsx` | Modified | Auto-save to history on generate |

---

## QA Results
_(To be completed by QA Agent)_
