# Story 3.5: Context Summary for AI

## Status

**Done**

---

## Story

**As a** system,
**I want** to compile weather and calendar data into a context object,
**so that** the AI can generate relevant outfit suggestions.

---

## Acceptance Criteria

1. Context object structure defined: `{ weather, events, date, dayOfWeek }`
2. Weather mapped to clothing needs (cold → layers, rain → waterproof)
3. Events mapped to occasion types (meeting → work, dinner → smart casual)
4. Context object available to AI prompt in Epic 4
5. Context stored temporarily for current session
6. Edge cases handled: no events, no weather, multiple events

---

## Tasks / Subtasks

- [x] **Task 1: Define context interfaces** (AC: 1)
  - [x] Create `apps/mobile/types/context.ts`
  - [x] Define `OutfitContext` interface with weather, events, date, dayOfWeek
  - [x] Define `WeatherContext` subset for AI consumption
  - [x] Define `EventContext` subset with occasion type

- [x] **Task 2: Create context service** (AC: 1, 5)
  - [x] Create `apps/mobile/services/contextService.ts`
  - [x] Implement `buildCurrentContext()` function
  - [x] Aggregate weather from weatherStore
  - [x] Aggregate events from calendarStore
  - [x] Add current date and day of week
  - [x] Return unified `OutfitContext` object

- [x] **Task 3: Enhance weather-to-clothing mapping** (AC: 2)
  - [x] Update `apps/mobile/utils/weatherClothingMap.ts`
  - [x] Create `mapWeatherToClothingNeeds()` function for AI context
  - [x] Return structured clothing needs (not just UI suggestions)
  - [x] Include: required categories, optional categories, conditions

- [x] **Task 4: Create occasion detector for events** (AC: 3)
  - [x] `detectOccasion()` already returns AI-friendly occasion types (existing)
  - [x] Added `getPrimaryOccasion()` to summarize multiple events
  - [x] Handle priority: formal > work > social > sport > casual

- [x] **Task 5: Create context store** (AC: 5)
  - [x] Create `apps/mobile/stores/contextStore.ts`
  - [x] Store current session context (not persisted)
  - [x] Add `refreshContext()` action that builds full context
  - [x] Add `getContextForAI()` selector for AI prompt building

- [x] **Task 6: Handle edge cases** (AC: 6)
  - [x] Handle no events: set `events: []` with `primaryOccasion: 'casual'`
  - [x] Handle no weather: return null weather in context
  - [x] Handle multiple events: determine primary occasion, list all events
  - [x] Handle conflicting occasions: use priority ranking

- [x] **Task 7: Integration hooks for Epic 4** (AC: 4)
  - [x] Export context types for AI prompts
  - [x] Create `formatContextForPrompt()` utility for text serialization
  - [x] Create `getContextSummary()` for quick reference

---

## Dev Notes

### Previous Story Insights
[Source: Stories 3.1-3.4]

**Weather data available from weatherStore:**
- `currentWeather`: temperature, feelsLike, condition, icon, weatherCode
- `forecast`: array of DailyForecast with high/low temps, conditions
- Location: city name, coordinates

**Calendar data available from calendarStore:**
- `events`: CalendarEvent[] from Google and/or Apple
- Each event has: title, startTime, endTime, location, isAllDay, occasion, source
- `occasion` already detected via `detectOccasion()` utility

**Existing utilities:**
- `weatherClothingMap.ts`: `getClothingSuggestions()` returns categories and tips
- `occasionDetector.ts`: `detectOccasion()` returns OccasionType from event title

### Data Models

```typescript
// Full context object for AI consumption
interface OutfitContext {
  date: string;                    // "2026-02-01"
  dayOfWeek: string;               // "Saturday"
  timeOfDay: 'morning' | 'afternoon' | 'evening';
  
  weather: {
    temperature: number;           // Current temp °C
    feelsLike: number;
    condition: string;             // "Partly cloudy"
    tempCategory: 'cold' | 'cool' | 'mild' | 'warm' | 'hot';
    clothingNeeds: ClothingNeeds;
    unavailable?: boolean;
  } | null;
  
  events: EventContext[];
  primaryOccasion: OccasionType;   // Highest priority occasion
  
  metadata: {
    hasWeather: boolean;
    hasEvents: boolean;
    eventCount: number;
  };
}

interface ClothingNeeds {
  required: string[];      // ['outerwear', 'layers']
  optional: string[];      // ['accessories']
  conditions: string[];    // ['rain', 'wind']
}

interface EventContext {
  title: string;
  time: string;            // "9:00 AM" or "All day"
  occasion: OccasionType;
  location?: string;
}
```

### Occasion Priority
When multiple events exist, determine primary occasion by priority:
1. `formal` (weddings, galas, interviews)
2. `work` (meetings, presentations)
3. `social` (dinners, parties, dates)
4. `sport` (gym, running, sports events)
5. `casual` (default if no events)

### File Locations

```
apps/mobile/
├── types/
│   └── context.ts           # NEW: Context interfaces
├── services/
│   └── contextService.ts    # NEW: Context building logic
├── stores/
│   └── contextStore.ts      # NEW: Session context store
├── utils/
│   ├── weatherClothingMap.ts  # UPDATE: Add AI-friendly mapping
│   └── occasionDetector.ts    # UPDATE: Add event summarization
```

### AI Prompt Format
The context will be serialized to text for AI prompts like:

```
Current Context:
- Date: Saturday, February 1st, 2026
- Weather: 12°C (feels like 10°C), Partly cloudy
- Clothing needs: Light jacket, consider layers
- Events:
  * 10:00 AM - Team standup meeting (work)
  * 7:00 PM - Dinner with friends (social)
- Primary occasion: Work (morning), transitioning to Social (evening)
```

### Coding Standards
[Source: architecture.md#Coding Standards]

- Use TypeScript strict mode
- Zustand store with actions pattern (no persistence for session context)
- Export types from types/ directory for reuse
- Service functions return `{ context, error }` pattern

---

## Testing

### Test File Location
`apps/mobile/__tests__/services/contextService.test.ts`
`apps/mobile/__tests__/stores/contextStore.test.ts`

### Test Cases

**Context Service:**
- Builds complete context with weather and events
- Returns null weather section when unavailable
- Returns empty events array when no events
- Correctly determines primary occasion from multiple events
- Formats date and day of week correctly
- Determines time of day based on current hour

**Occasion Priority:**
- Formal takes priority over work
- Work takes priority over social
- Multiple casual events don't override single work event
- Default to casual when no events

**Edge Cases:**
- Context with no weather connection
- Context with no calendar connection
- Context with 5+ events (summarization)
- Context at midnight (day boundary)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude (Anthropic) via Antigravity

### Debug Log References
N/A - TypeScript check passed with no errors

### Completion Notes List
- Created `types/context.ts` with `OutfitContext`, `WeatherContext`, `EventContext`, `ClothingNeeds` interfaces
- Added `getPrimaryOccasion()`, `getTimeOfDay()`, `formatDateForContext()` helper functions
- Created `services/contextService.ts` with `buildCurrentContext()`, `formatContextForPrompt()`, `getContextSummary()`
- Added `mapWeatherToClothingNeeds()` to `weatherClothingMap.ts` for AI-structured clothing needs
- Created `stores/contextStore.ts` with session-only context storage and refresh actions
- All edge cases handled: no events → casual, no weather → null, multiple events → priority ranking

### File List

| File | Action | Description |
|------|--------|-------------|
| `apps/mobile/types/context.ts` | NEW | Context interfaces and helper functions |
| `apps/mobile/services/contextService.ts` | NEW | Context building and formatting service |
| `apps/mobile/stores/contextStore.ts` | NEW | Session-only context store |
| `apps/mobile/utils/weatherClothingMap.ts` | MODIFIED | Added `mapWeatherToClothingNeeds()` |
