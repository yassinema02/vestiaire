# Story 4.7: Morning Push Notification

## Status

**Draft**

---

## Story

**As a** user,  
**I want** to receive a morning notification with today's outfit,  
**so that** I can start my day with a suggestion.

---

## Acceptance Criteria

1. Push notification scheduled for user-configurable time (default 7 AM)
2. Notification text: "Good morning! Here's your outfit for today ☀️"
3. Tap notification opens app to today's outfit suggestion
4. Notification includes weather preview in subtitle
5. User can disable in settings
6. Implemented via Expo Push Notifications + backend scheduler

---

## Tasks / Subtasks

- [ ] **Task 1: Configure Expo Push Notifications** (AC: 6)
  - [ ] Install `expo-notifications` package
  - [ ] Configure `app.json` with push notification permissions
  - [ ] Request notification permissions on app launch
  - [ ] Set up notification handler for foreground/background
  - [ ] Store Expo push token in Supabase user profile

- [ ] **Task 2: Create Notification Preferences Storage** (AC: 1, 5)
  - [ ] Add notification settings to user profile table
  - [ ] Fields: `notifications_enabled`, `notification_time` (default 07:00)
  - [ ] Create `notificationService.ts` for preference management
  - [ ] Add getPreferences/updatePreferences methods

- [ ] **Task 3: Add Notification Settings UI** (AC: 1, 5)
  - [ ] Add "Notifications" section in Profile/Settings screen
  - [ ] Toggle switch for "Morning Outfit Reminder"
  - [ ] Time picker for notification time (default 7 AM)
  - [ ] Save preferences to Supabase on change

- [ ] **Task 4: Implement Local Scheduled Notifications** (AC: 1, 2, 3, 4)
  - [ ] Schedule daily repeating notification at user's chosen time
  - [ ] Notification content includes weather preview
  - [ ] Configure deep link to open Home tab with outfit
  - [ ] Cancel/reschedule when user changes time
  - [ ] Cancel all when user disables notifications

- [ ] **Task 5: Handle Notification Tap Navigation** (AC: 3)
  - [ ] Set up notification response listener
  - [ ] Navigate to Home tab when notification tapped
  - [ ] Trigger outfit generation if not already loaded
  - [ ] Handle cold start vs warm start scenarios

- [ ] **Task 6: Testing**
  - [ ] Test notification permission request flow
  - [ ] Test scheduling/canceling notifications
  - [ ] Test notification tap opens correct screen
  - [ ] Test settings persistence across app restarts

---

## Dev Notes

### Previous Story Insights (from Story 4.6)
- Profile screen already exists for settings
- Weather context already available from `weatherService`
- Home screen displays daily outfit suggestion

### Required Packages

```bash
npx expo install expo-notifications
```

### Expo Notifications Setup `[Source: Expo docs]`

**app.json configuration:**
```json
{
  "expo": {
    "plugins": [
      [
        "expo-notifications",
        {
          "icon": "./assets/notification-icon.png",
          "color": "#6366f1",
          "sounds": []
        }
      ]
    ]
  }
}
```

### Data Model Updates

**Add to user_profiles table:**
```sql
ALTER TABLE user_profiles ADD COLUMN notifications_enabled BOOLEAN DEFAULT TRUE;
ALTER TABLE user_profiles ADD COLUMN notification_time TIME DEFAULT '07:00:00';
ALTER TABLE user_profiles ADD COLUMN expo_push_token TEXT;
```

### API Methods

**notificationService.ts:**
```typescript
interface NotificationPreferences {
  notifications_enabled: boolean;
  notification_time: string; // HH:mm format
  expo_push_token: string | null;
}

const notificationService = {
  getPreferences(): Promise<NotificationPreferences>;
  updatePreferences(prefs: Partial<NotificationPreferences>): Promise<void>;
  scheduleNotification(time: string): Promise<void>;
  cancelAllNotifications(): Promise<void>;
  registerForPushNotifications(): Promise<string | null>;
};
```

### Notification Content

| Field | Value |
|-------|-------|
| Title | "Good morning! ☀️" |
| Body | "Here's your outfit for today" |
| Subtitle | Weather preview (e.g., "72°F, Sunny") |
| Data | `{ screen: 'home', action: 'show-outfit' }` |

### UI Components `[Source: front-end-spec.md]`

| Component | Usage |
|-----------|-------|
| **Switch** | Toggle notifications on/off |
| **Time Picker** | Select notification time |
| **Section Card** | Settings section container |

**Design Colors:**
- Toggle active: `#7D9A78` (accent green)
- Settings text: `#5D4E37` (primary brown)

### File Locations

| File | Path |
|------|------|
| Notification Service | `apps/mobile/services/notificationService.ts` |
| Profile/Settings | `apps/mobile/app/(tabs)/profile.tsx` |
| App Entry | `apps/mobile/app/_layout.tsx` |
| App Config | `apps/mobile/app.json` |
| Migrations | `supabase/migrations/` |

### Testing Notes

- Use Expo Go for basic testing
- Physical device required for full notification testing
- Simulator does not support push tokens

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
N/A — clean implementation, no debug issues

### Completion Notes List
- Created migration 005 adding notifications_enabled, notification_time, expo_push_token to profiles table
- Created full notificationService.ts with: push registration, token storage, preference CRUD, local scheduled notifications, weather preview subtitle, initialize flow
- Added expo-notifications plugin to app.config.js
- Added Notifications section to profile screen with Switch toggle (green accent) and DateTimePicker for time
- Replaced placeholder Notifications menu item with the real settings section
- Wired up notification handler (foreground display) and response listener (tap navigation to Home) in root _layout.tsx
- Notifications initialize automatically once user is authenticated
- Android notification channel configured for morning outfit reminders
- Time picker uses compact mode on iOS, spinner with button on Android

### File List

| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/005_add_notification_preferences.sql` | Created | Migration adding notification columns to profiles |
| `apps/mobile/services/notificationService.ts` | Created | Full notification service (register, preferences, scheduling) |
| `apps/mobile/app.config.js` | Modified | Added expo-notifications plugin |
| `apps/mobile/app/(tabs)/profile.tsx` | Modified | Added notification settings UI (toggle + time picker) |
| `apps/mobile/app/_layout.tsx` | Modified | Added notification handler, initialization, tap navigation |

---

## QA Results
_(To be completed by QA Agent)_
