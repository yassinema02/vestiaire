# Story 8.1: Screenshot Product Analysis

## Status

**Draft**

## Story

**As a** shopper browsing Instagram or shopping apps,
**I want** to screenshot a product and see if it matches my wardrobe,
**so that** I can avoid buying items that won't work with what I own.

## Acceptance Criteria

1. "Check Before You Buy" button prominently displayed on Home screen
2. User can upload screenshot from gallery or take new photo
3. App detects product in image (clothing item, not background)
4. Loading indicator shows "Analyzing..." (3-5 seconds)
5. If multiple items detected, user selects which to analyze
6. Error handling: low quality images show warning
7. Successful analysis displays compatibility results screen

## Tasks / Subtasks

- [ ] **Task 1: Database Migration ‚Äì `shopping_scans` table** (AC: 3, 7)
  - [ ] Create migration `018_create_shopping_scans.sql` in `supabase/migrations/`
  - [ ] Schema: `id`, `user_id`, `product_name`, `product_brand`, `product_url`, `product_image_url`, `category`, `color`, `secondary_colors`, `style`, `material`, `pattern`, `season`, `formality`, `price_amount`, `price_currency`, `compatibility_score`, `matching_item_ids`, `ai_insights`, `scan_method`, `user_rating`, `created_at`
  - [ ] Add RLS policies (users can CRUD own scans only)
  - [ ] Add indexes: `user_id`, `created_at DESC`, `compatibility_score DESC`
  - [ ] Test migration locally with `supabase db push`

- [ ] **Task 2: Storage Bucket ‚Äì `shopping-scans`** (AC: 2)
  - [ ] Create `shopping-scans` storage bucket (private) in Supabase
  - [ ] Add storage policy: users can upload to own folder (`auth.uid()::text = (storage.foldername(name))[1]`)
  - [ ] Add storage policy: users can read own uploads

- [ ] **Task 3: TypeScript Types** (AC: 3, 7)
  - [ ] Create `apps/mobile/types/shopping.ts` with `ShoppingScan` interface matching DB schema
  - [ ] Add `ScanMethod = 'screenshot' | 'url'` type
  - [ ] Add `CompatibilityRating` type with thresholds: Perfect Match üéØ (90-100), Great Choice ‚ú® (75-89), Good Fit üëç (60-74), Might Work ‚ö†Ô∏è (40-59), Careful ‚ùó (0-39)

- [ ] **Task 4: Shopping Scan Service** (AC: 2, 3, 4, 6)
  - [ ] Create `apps/mobile/services/shoppingService.ts`
  - [ ] Implement `uploadScreenshot(imageUri: string): Promise<string>` ‚Äî uploads image to `shopping-scans` bucket, returns public URL
  - [ ] Implement `analyzeScreenshot(imageUrl: string): Promise<ShoppingScan>` ‚Äî calls Gemini API via Edge Function to extract product data from image
  - [ ] Implement `saveScan(scan: Partial<ShoppingScan>): Promise<ShoppingScan>` ‚Äî inserts scan into `shopping_scans` table
  - [ ] Implement `getScanHistory(limit?: number): Promise<ShoppingScan[]>` ‚Äî fetches user's scan history
  - [ ] Implement `deleteScan(scanId: string): Promise<void>`
  - [ ] Add error handling: low quality image detection, API failures, timeout (10s)

- [ ] **Task 5: Supabase Edge Function ‚Äì `analyze-product`** (AC: 3, 4)
  - [ ] Create `supabase/functions/analyze-product/index.ts`
  - [ ] Accept `{ image_url: string }` as POST body
  - [ ] Call Gemini 1.5 Pro API with structured prompt to extract: `product_name`, `category`, `color`, `secondary_colors`, `style`, `material`, `pattern`, `season`, `formality`
  - [ ] Return structured JSON response with extracted product data
  - [ ] Include confidence score in response
  - [ ] Handle Gemini API errors gracefully (rate limit, invalid image)
  - [ ] Validate auth token from request headers
  - [ ] Keep Gemini API key server-side only (use `Deno.env.get('GEMINI_API_KEY')`)

- [ ] **Task 6: Shopping Store (Zustand)** (AC: 4, 7)
  - [ ] Create `apps/mobile/stores/shoppingStore.ts`
  - [ ] State: `currentScan`, `scanHistory`, `isAnalyzing`, `analysisError`
  - [ ] Actions: `startAnalysis(imageUri)`, `clearScan()`, `loadHistory()`
  - [ ] `startAnalysis` should orchestrate: upload ‚Üí analyze ‚Üí save ‚Üí update state

- [ ] **Task 7: "Check Before You Buy" Button on Home Screen** (AC: 1)
  - [ ] Add prominent CTA button to `apps/mobile/app/(tabs)/index.tsx`
  - [ ] Button style: gradient background, shopping bag icon, positioned below outfit widget
  - [ ] Button text: "Check Before You Buy üõçÔ∏è"
  - [ ] On press: navigate to Shopping Assistant screen

- [ ] **Task 8: Shopping Assistant Screen** (AC: 2, 4, 5, 6)
  - [ ] Create `apps/mobile/app/(tabs)/shopping.tsx` (or modal route)
  - [ ] Two input methods: "Upload Screenshot" (gallery picker) and "Take Photo" (camera)
  - [ ] Use `expo-image-picker` (already installed) for gallery/camera access
  - [ ] Show selected image preview after picking
  - [ ] "Analyze" button triggers analysis flow
  - [ ] Loading state: animated spinner with "Analyzing your item..." text
  - [ ] Error state: "We couldn't analyze this image. Try a clearer photo." with retry button

- [ ] **Task 9: Multi-Item Selection** (AC: 5)
  - [ ] If Gemini detects multiple items in the image, show selection UI
  - [ ] Display detected items as labeled bounding areas or numbered list
  - [ ] User taps to select which item to analyze
  - [ ] Default to most prominent item if only one detected

- [ ] **Task 10: Compatibility Results Screen** (AC: 7)
  - [ ] Create `apps/mobile/app/(tabs)/scan-results.tsx` (or component)
  - [ ] Display: Product image, name, brand, category
  - [ ] Compatibility score: large number (0-100) with color-coded progress bar
  - [ ] Rating label: "Perfect Match üéØ", "Great Choice ‚ú®", etc.
  - [ ] Score explanation text: "Based on your {wardrobe insight}"
  - [ ] Navigation: back to scan, save to wishlist (future story 8.7)

- [ ] **Task 11: Unit Tests** (AC: all)
  - [ ] Test `shoppingService.ts`: upload, analyze, save, getHistory
  - [ ] Test `shoppingStore.ts`: state transitions during analysis flow
  - [ ] Test Edge Function: mock Gemini response, error handling
  - [ ] Test types: validate `CompatibilityRating` thresholds

## Dev Notes

### Previous Story Insights
- Story 7.7 (Premium Onboarding Reward) is the last completed V1 story ‚Äî all V1 epics are done
- This is the **first V2 story** ‚Äî begins Epic 8: Shopping Assistant
- V2 uses **Gemini 1.5 Pro** instead of OpenAI for AI features (strategic decision made during V2 planning)
  [Source: docs/vestiaire-v2-brief-revised.md]

### Data Models

**`shopping_scans` table** ‚Äî stores all screenshot/URL analysis results:

```typescript
interface ShoppingScan {
  id: string;                    // UUID
  user_id: string;               // FK ‚Üí auth.users
  product_name: string | null;
  product_brand: string | null;
  product_url: string | null;
  product_image_url: string | null;
  category: string | null;       // 'tops', 'bottoms', 'shoes', etc.
  color: string | null;
  secondary_colors: string[];
  style: string | null;          // 'casual', 'formal', 'sporty'
  material: string | null;
  pattern: string | null;        // 'solid', 'striped', 'floral'
  season: string[];              // ['spring', 'summer']
  formality: number | null;      // 1-10
  price_amount: number | null;
  price_currency: string;        // default 'GBP'
  compatibility_score: number | null; // 0-100
  matching_item_ids: string[];   // UUIDs of matching wardrobe items
  ai_insights: object | null;    // JSONB [{category, text}]
  scan_method: 'screenshot' | 'url';
  user_rating: number | null;    // 1-5
  created_at: string;
}
```
[Source: docs/database-migrations-v2.md#Migration 018]

**Existing `items` table** ‚Äî needed for wardrobe comparison:
```typescript
interface Item {
  id: string;
  user_id: string;
  name: string | null;
  category: Category;            // 'tops' | 'bottoms' | 'dresses' | 'outerwear' | 'shoes' | 'accessories'
  color: string;
  brand: string | null;
  seasons: Season[];
  occasions: Occasion[];
  // ... other fields
}
```
[Source: docs/architecture.md#Data Models]

### API Specifications

**New Edge Function: `analyze-product`**
- **Endpoint:** `POST /functions/v1/analyze-product`
- **Auth:** Bearer token (Supabase auth JWT) in Authorization header
- **Request:** `{ image_url: string }`
- **Response:** Structured product data (see schema above)
- **AI Model:** Gemini 1.5 Pro via `@google/generative-ai` npm package
- **API Key:** `Deno.env.get('GEMINI_API_KEY')` ‚Äî server-side only
[Source: docs/architecture.md#API Specification, docs/vestiaire-v2-brief-revised.md]

**Existing Edge Functions pattern:**
- All functions in `supabase/functions/{function-name}/index.ts`
- Use Deno runtime
- Validate auth via `supabase.auth.getUser(authHeader)`
- Return JSON with appropriate HTTP status codes
[Source: docs/architecture.md#Edge Functions]

### Component Specifications

**Home Screen CTA:**
- Button placed below the Outfit Suggestion Widget on `index.tsx`
- Use NativeWind styling (TailwindCSS syntax)
- Gradient background matching app theme
- Shopping bag icon (Ionicons: `bag-outline`)

**Shopping Assistant Screen:**
- New screen: `apps/mobile/app/(tabs)/shopping.tsx`
- Uses `expo-image-picker` (already in project) for gallery/camera
- Image preview after selection
- Animated loading state (3-5 seconds expected)

**Results Screen:**
- New screen: `apps/mobile/app/(tabs)/scan-results.tsx`
- Score progress bar (color gradient: green ‚Üí yellow ‚Üí red based on score)
- Product card with extracted information

### File Locations

| File | Purpose |
|------|---------|
| `supabase/migrations/018_create_shopping_scans.sql` | Database migration |
| `supabase/functions/analyze-product/index.ts` | Gemini product extraction Edge Function |
| `apps/mobile/types/shopping.ts` | TypeScript types for shopping feature |
| `apps/mobile/services/shoppingService.ts` | Shopping API service layer |
| `apps/mobile/stores/shoppingStore.ts` | Zustand store for shopping state |
| `apps/mobile/app/(tabs)/shopping.tsx` | Shopping Assistant screen |
| `apps/mobile/app/(tabs)/scan-results.tsx` | Compatibility results screen |
[Source: docs/architecture.md#Project Structure]

### Technical Constraints

- **Gemini API Key:** Must remain server-side only (Edge Function). Never expose in client code.
- **Image size:** Limit uploads to 10MB max. Compress before upload if needed.
- **RLS:** All `shopping_scans` queries must go through RLS ‚Äî users see only their own scans.
- **Storage:** Screenshots uploaded to `shopping-scans` bucket with user ID as folder prefix.
- **Freemium:** Consider scan limits per day (3 free, unlimited premium) ‚Äî align with existing `usageLimitsService.ts` pattern.
- **State Management:** Use Zustand for client state (consistent with V1 pattern: `authStore.ts`, `outfitStore` etc.)
- **Server State:** Consider TanStack Query for scan history caching (matches architecture).
[Source: docs/architecture.md#Tech Stack, docs/architecture.md#Architecture Patterns]

### Testing

- **Test file location:** Co-located or in `__tests__/` directory alongside source files
- **Test framework:** Jest + React Native Testing Library
- **Test standards:**
  - Service tests: mock Supabase client, test CRUD operations
  - Store tests: verify state transitions
  - Edge Function tests: mock Gemini API responses
  - Component tests: render and verify UI elements, user interactions
[Source: docs/architecture.md#Tech Stack]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 1.0 | Initial story draft | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
