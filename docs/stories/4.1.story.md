# Story 4.1: Outfit Data Model & Storage

## Status

**Done**

---

## Story

**As a** developer,
**I want** a database structure to store outfits and their relationships to items,
**so that** generated and saved outfits can be retrieved.

---

## Acceptance Criteria

1. `outfits` table created: id, user_id, name, occasion, is_ai_generated, created_at
2. `outfit_items` junction table: outfit_id, item_id, position
3. RLS policies ensure users only see their own outfits
4. Outfit can have 2-6 items (minimum top+bottom or dress)
5. API endpoints for CRUD operations on outfits
6. Outfit marked with weather context at creation time

---

## Tasks / Subtasks

- [x] **Task 1: Create database migration** (AC: 1, 2, 6)
  - [x] Create Supabase migration file
  - [x] Create `outfits` table with all required columns
  - [x] Create `outfit_items` junction table
  - [x] Add indexes for performance

- [x] **Task 2: Setup RLS policies** (AC: 3)
  - [x] Add RLS policy for SELECT on outfits (own outfits only)
  - [x] Add RLS policy for INSERT on outfits (authenticated users)
  - [x] Add RLS policy for UPDATE on outfits (own outfits only)
  - [x] Add RLS policy for DELETE on outfits (own outfits only)
  - [x] Add matching policies for outfit_items

- [x] **Task 3: Create TypeScript types** (AC: 1, 2)
  - [x] Create `types/outfit.ts` with Outfit and OutfitItem interfaces
  - [x] Define occasion types aligned with context system
  - [x] Export types for use across app

- [x] **Task 4: Create outfit service** (AC: 5)
  - [x] Create `services/outfitService.ts`
  - [x] Implement `createOutfit()` function
  - [x] Implement `getOutfits()` with pagination
  - [x] Implement `getOutfitById()` with items
  - [x] Implement `updateOutfit()` function
  - [x] Implement `deleteOutfit()` function

- [x] **Task 5: Create outfit store** (AC: 5)
  - [x] Create `stores/outfitStore.ts`
  - [x] Add state for outfits list and current outfit
  - [x] Add loading and error states
  - [x] Add CRUD actions

- [x] **Task 6: Add validation** (AC: 4)
  - [x] Validate minimum 2 items per outfit
  - [x] Validate maximum 6 items per outfit
  - [x] Validate at least top+bottom OR dress
  - [x] Add validation error messages

---

## Dev Notes

### Previous Story Insights
[Source: architecture.md]

**Database schema already defined:**
```sql
CREATE TABLE outfits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  name TEXT,
  occasion TEXT,
  is_ai_generated BOOLEAN DEFAULT FALSE,
  weather_context JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE outfit_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  outfit_id UUID NOT NULL REFERENCES outfits(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id) ON DELETE CASCADE,
  position TEXT NOT NULL
);
```

**WeatherContext from Story 3.5:**
The `weather_context` JSONB field will store the context snapshot at outfit creation time for reference.

### Data Models

```typescript
import { OccasionType } from '../utils/occasionDetector';

interface Outfit {
  id: string;
  user_id: string;
  name: string | null;
  occasion: OccasionType | null;
  is_ai_generated: boolean;
  weather_context: WeatherContextSnapshot | null;
  created_at: string;
  items?: OutfitItem[];
}

interface OutfitItem {
  id: string;
  outfit_id: string;
  item_id: string;
  position: 'top' | 'bottom' | 'shoes' | 'accessory' | 'outerwear' | 'dress';
  item?: WardrobeItem;  // Populated via join
}

interface WeatherContextSnapshot {
  temperature: number;
  condition: string;
  date: string;
}
```

### File Locations

```
apps/mobile/
├── types/
│   └── outfit.ts           # NEW: Outfit types
├── services/
│   └── outfitService.ts    # NEW: Outfit CRUD operations
├── stores/
│   └── outfitStore.ts      # NEW: Outfit state management

supabase/
├── migrations/
│   └── YYYYMMDD_create_outfits.sql  # NEW: Outfit tables
```

### Validation Rules
- Minimum 2 items
- Maximum 6 items
- Must have: (top + bottom) OR dress
- All items must belong to user
- Each position can appear once per outfit

---

## Testing

### Test Cases

**Database:**
- Outfit creation with valid data succeeds
- Outfit creation without user_id fails (RLS)
- User can only see their own outfits
- Cascade delete removes outfit_items

**Validation:**
- Outfit with 1 item fails validation
- Outfit with 7 items fails validation
- Outfit without top or bottom (and no dress) fails
- Outfit with dress only passes

**Service:**
- CRUD operations work correctly
- Items are populated via join
- Pagination works correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude (Anthropic) via Antigravity

### Debug Log References
TypeScript check passed (only pre-existing error in aiCategorization.ts)

### Completion Notes List
1. Created `types/outfit.ts` with Outfit, OutfitItem, WeatherContextSnapshot interfaces
2. Added OutfitPosition type and CreateOutfitInput/UpdateOutfitInput types
3. Implemented `validateOutfitItems()` for 2-6 items and top+bottom/dress requirements
4. Created `services/outfitService.ts` with full CRUD (create, get, update, delete)
5. Added pagination support and outfit count function
6. Created `stores/outfitStore.ts` with Zustand, pagination, and error handling
7. Created `supabase/migrations/003_outfits_table.sql` with tables and RLS policies
8. Added position constraint CHECK for valid positions

### File List

| File | Action | Description |
|------|--------|-------------|
| `apps/mobile/types/outfit.ts` | NEW | Outfit types and validation |
| `apps/mobile/services/outfitService.ts` | NEW | CRUD operations for outfits |
| `apps/mobile/stores/outfitStore.ts` | NEW | Zustand state management |
| `supabase/migrations/003_outfits_table.sql` | NEW | Database tables and RLS |
