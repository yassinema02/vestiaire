# Story 2.1: Camera Capture & Image Upload

## Status

**In Progress**

---

## Story

**As a** user,  
**I want** to take a photo of my clothing item directly in the app,  
**so that** I can quickly add items to my wardrobe.

---

## Acceptance Criteria

1. "Add Item" button opens camera with photo capture option
2. Option to select from photo library as alternative
3. Image preview shown before confirming upload
4. Images compressed to max 2MB before upload
5. Upload progress indicator displayed
6. Image stored in Supabase Storage with signed URL
7. Camera permission request handled gracefully

---

## Tasks / Subtasks

- [x] **Task 1: Install camera and image dependencies** (AC: 1, 2, 7)
  - [x] Install `expo-camera` for camera access
  - [x] Install `expo-image-picker` for gallery access
  - [x] Install `expo-media-library` for saving photos
  - [x] Install `expo-image-manipulator` for image compression
  - [x] Update app.config.js with camera permission strings

- [/] **Task 2: Create Supabase Storage bucket** (AC: 6)
  - [ ] Create `wardrobe-images` bucket in Supabase (USER ACTION REQUIRED)
  - [ ] Configure RLS policies for bucket access (USER ACTION REQUIRED)
  - [x] Create storage service helper functions

- [x] **Task 3: Implement camera capture screen** (AC: 1, 7)
  - [x] Create camera capture screen in Add tab flow
  - [x] Request and handle camera permissions
  - [x] Implement photo capture with preview
  - [x] Add flash toggle and camera flip buttons
  - [x] Show permission denied state with settings link

- [x] **Task 4: Implement gallery picker** (AC: 2)
  - [x] Add "Choose from Gallery" option
  - [x] Request media library permissions
  - [x] Open image picker with aspect ratio options
  - [x] Handle picker cancellation

- [x] **Task 5: Image preview and confirmation** (AC: 3)
  - [x] Create preview screen showing captured/selected image
  - [x] Add "Retake"/"Choose another" button
  - [x] Add "Use Photo" confirmation button
  - [x] Display image metadata (size)

- [x] **Task 6: Image compression** (AC: 4)
  - [x] Compress images to max 2MB
  - [x] Resize large images while maintaining aspect ratio
  - [x] Progressive quality reduction if still too large
  - [x] Fallback for compression failure

- [x] **Task 7: Upload to Supabase Storage** (AC: 5, 6)
  - [x] Create upload service with progress tracking
  - [x] Generate unique filename with user ID prefix
  - [x] Upload compressed image to `wardrobe-images` bucket
  - [x] Get public URL for uploaded image
  - [x] Handle upload errors with retry option

- [/] **Task 8: Create initial item record** (AC: 6)
  - [x] Create `items` table migration (SQL ready)
  - [ ] Run migration in Supabase (USER ACTION REQUIRED)
  - [x] Save initial item record with image URL
  - [x] Set status as "pending" for later AI analysis
  - [x] Navigate to wardrobe on success

---

## Dev Notes

### Previous Story Insights
[Source: Story 1.6 Completion Notes]
- App shell complete with tab navigation
- Add tab screen exists as placeholder
- Ionicons used for all icons
- Supabase client configured at `services/supabase.ts`

### Dependencies to Install

```bash
npx expo install expo-camera expo-image-picker expo-media-library expo-image-manipulator
```

### Database Schema - Items Table
[Source: architecture.md#database-schema]

```sql
-- Create items table for wardrobe items
CREATE TABLE items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  image_url TEXT NOT NULL,
  original_image_url TEXT,
  processed_image_url TEXT,
  name TEXT,
  brand TEXT,
  category TEXT,
  sub_category TEXT,
  colors TEXT[],
  seasons TEXT[],
  occasions TEXT[],
  purchase_price DECIMAL(10,2),
  purchase_date DATE,
  wear_count INTEGER DEFAULT 0,
  last_worn_at TIMESTAMPTZ,
  is_favorite BOOLEAN DEFAULT false,
  status TEXT DEFAULT 'pending', -- pending, processing, complete
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE items ENABLE ROW LEVEL SECURITY;

-- Users can only see their own items
CREATE POLICY "Users can view own items" ON items
  FOR SELECT USING (auth.uid() = user_id);

-- Users can insert their own items
CREATE POLICY "Users can insert own items" ON items
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Users can update their own items
CREATE POLICY "Users can update own items" ON items
  FOR UPDATE USING (auth.uid() = user_id);

-- Users can delete their own items
CREATE POLICY "Users can delete own items" ON items
  FOR DELETE USING (auth.uid() = user_id);

-- Updated at trigger
CREATE TRIGGER update_items_updated_at
  BEFORE UPDATE ON items
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

### Storage Configuration
[Source: Supabase docs]

```typescript
// services/storage.ts
import { supabase } from './supabase';

const BUCKET_NAME = 'wardrobe-images';

export const storageService = {
  uploadImage: async (userId: string, imageUri: string): Promise<{ url: string; error: Error | null }> => {
    const filename = `${userId}/${Date.now()}.jpg`;
    const response = await fetch(imageUri);
    const blob = await response.blob();
    
    const { data, error } = await supabase.storage
      .from(BUCKET_NAME)
      .upload(filename, blob, {
        contentType: 'image/jpeg',
        upsert: false,
      });
    
    if (error) return { url: '', error };
    
    const { data: urlData } = supabase.storage
      .from(BUCKET_NAME)
      .getPublicUrl(data.path);
    
    return { url: urlData.publicUrl, error: null };
  },
};
```

### Camera Permission Strings
[Source: iOS/Android requirements]

```javascript
// In app.config.js plugins array
plugins: [
  'expo-router',
  [
    'expo-camera',
    {
      cameraPermission: 'Allow Vestiaire to access your camera to photograph clothing items.',
    },
  ],
  [
    'expo-image-picker',
    {
      photosPermission: 'Allow Vestiaire to access your photos to add clothing items.',
    },
  ],
],
```

### Image Compression
[Source: expo-image-manipulator docs]

```typescript
import * as ImageManipulator from 'expo-image-manipulator';

const compressImage = async (uri: string): Promise<string> => {
  const MAX_SIZE = 2 * 1024 * 1024; // 2MB
  let quality = 0.8;
  let result = await ImageManipulator.manipulateAsync(
    uri,
    [{ resize: { width: 1200 } }],
    { compress: quality, format: ImageManipulator.SaveFormat.JPEG }
  );
  
  // Further compress if still too large
  while (quality > 0.3) {
    const response = await fetch(result.uri);
    const blob = await response.blob();
    if (blob.size <= MAX_SIZE) break;
    quality -= 0.1;
    result = await ImageManipulator.manipulateAsync(
      uri,
      [{ resize: { width: 1200 } }],
      { compress: quality, format: ImageManipulator.SaveFormat.JPEG }
    );
  }
  
  return result.uri;
};
```

---

## Testing

### Test Cases

1. **Camera Capture**
   - Open Add screen → tap "Take Photo" → camera opens
   - Capture photo → preview shown
   - Flip camera → front/back switches
   - Flash toggle → flash mode changes

2. **Gallery Selection**
   - Open Add screen → tap "Choose from Gallery" → picker opens
   - Select image → preview shown
   - Cancel picker → returns to Add screen

3. **Permissions**
   - First camera use → permission dialog shown
   - Deny permission → helpful message with settings link
   - Grant permission → camera opens

4. **Image Upload**
   - Confirm image → upload progress shown
   - Upload completes → item created in database
   - Network error → retry option shown

5. **Image Compression**
   - Large image (>2MB) → compressed before upload
   - Compressed image quality acceptable

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
