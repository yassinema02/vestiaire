# Story 5.2: Evening Reminder Notification

## Status

**Implemented (notification scheduling stubbed ‚Äî requires dev build)**

---

## Story

**As a** user,  
**I want** an evening reminder to log my outfit,  
**so that** I don't forget to track what I wore.

---

## Acceptance Criteria

1. Push notification at user-configurable time (default 8 PM)
2. Notification: "What did you wear today? Log your outfit! üìù"
3. Tap opens app to wear logging screen
4. Notification skipped if outfit already logged today
5. User can disable in settings
6. Smart timing: not sent if app was opened recently

---

## Tasks / Subtasks

- [x] **Task 1: Extend Notification Preferences** (AC: 1, 5)
  - [x] Add `evening_reminder_enabled` to profiles table (migration 007)
  - [x] Add `evening_reminder_time` (default 20:00) to profiles table
  - [x] Created `eveningReminderService.ts` with preference types
  - [x] Implemented getPreferences() and updatePreferences() methods

- [x] **Task 2: Add Evening Reminder Settings UI** (AC: 1, 5)
  - [x] Add "Evening Reminder" section in Profile Settings
  - [x] Toggle switch for enable/disable
  - [x] Time picker for notification time (iOS compact / Android spinner)
  - [x] Display current setting status with hint text

- [x] **Task 3: Implement Smart Scheduling Logic** (AC: 4, 6)
  - [x] Check if outfit already logged today before scheduling
  - [x] Store last app open time in AsyncStorage (recorded in root layout)
  - [x] Skip notification if app opened within last 2 hours
  - [x] Method: `shouldSendReminder()`

- [ ] **Task 4: Schedule Evening Notification** (AC: 1, 2) ‚Äî *Stubbed (requires dev build)*
  - [ ] Use expo-notifications to schedule daily notification
  - [ ] Notification content configured in TODO comments
  - [ ] Cancel/reschedule when user changes time (logic in place, actual call stubbed)

- [ ] **Task 5: Handle Notification Tap Navigation** (AC: 3) ‚Äî *Stubbed (requires dev build)*
  - [ ] Configure deep link to log-wear screen
  - [ ] Add notification response handler in _layout.tsx
  - [ ] Navigate to `/(tabs)/log-wear` on tap

- [ ] **Task 6: Testing**
  - [ ] Test settings persistence
  - [ ] Test smart skip logic
  - [ ] Test notification scheduling (after dev build)
  - [ ] Test navigation on tap (after dev build)

---

## Dev Notes

### ‚ö†Ô∏è Important: Native Build Required

> [!WARNING]
> **Push notifications require a development build, NOT Expo Go.**
> 
> expo-notifications and expo-device native modules are not available in Expo Go.
> This story should be implemented and tested using `npx expo run:ios` or `eas build`.

### Previous Story Insights (from Story 5.1)
- Wear logging is implemented in `log-wear.tsx` screen
- `wearLogService.getItemsWornToday()` checks if items logged today
- Profile screen has settings section structure

### Data Model Updates

**Migration 007:**
```sql
ALTER TABLE profiles 
ADD COLUMN evening_reminder_enabled BOOLEAN DEFAULT TRUE,
ADD COLUMN evening_reminder_time TIME DEFAULT '20:00:00';
```

### API Methods

**notificationService.ts updates:**
```typescript
interface EveningReminderPreferences {
    enabled: boolean;
    time: string; // HH:mm format
}

// Add to notificationService:
getEveningReminderPreferences(): Promise<EveningReminderPreferences>;
updateEveningReminderPreferences(prefs: Partial<EveningReminderPreferences>): Promise<void>;
scheduleEveningReminder(time: string): Promise<void>;
shouldSendEveningReminder(): Promise<boolean>;
```

### Notification Content

| Field | Value |
|-------|-------|
| Title | "What did you wear today? üìù" |
| Body | "Log your outfit to track your wardrobe" |
| Data | `{ screen: 'log-wear', action: 'log-outfit' }` |

### Smart Skip Logic

Skip evening reminder if:
1. User already logged an outfit today
2. App was opened in the last 2 hours
3. Evening reminder is disabled in settings

### File Locations

| File | Path |
|------|------|
| Migration | `supabase/migrations/007_evening_reminder_preferences.sql` |
| Service | `apps/mobile/services/notificationService.ts` |
| Profile Settings | `apps/mobile/app/(tabs)/profile.tsx` |
| Root Layout | `apps/mobile/app/_layout.tsx` |
| Wear Log Screen | `apps/mobile/app/(tabs)/log-wear.tsx` |

### Dependencies on Other Stories

- Story 5.1: Wear logging system ‚úÖ
- Story 4.7: Morning notification (deferred ‚Äî same expo-notifications challenges)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues ‚Äî notification scheduling intentionally stubbed to avoid Expo Go crashes.

### Completion Notes List
- Created dedicated `eveningReminderService.ts` (not extending a non-existent notificationService, since 4.7 was rolled back)
- Preferences (enabled/time) stored in `profiles` table via Supabase
- Smart skip logic fully implemented: checks wear logs for today, checks last app open time via AsyncStorage
- `recordAppOpen()` called from root `_layout.tsx` on mount
- Notification scheduling methods are stubbed with TODO comments containing the exact expo-notifications code to use when switching to a dev build
- Time picker uses `@react-native-community/datetimepicker` ‚Äî compact mode on iOS, spinner on Android
- Toggle uses optimistic update with revert on error

### File List

| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/007_evening_reminder_preferences.sql` | Created | Adds evening_reminder_enabled and evening_reminder_time to profiles |
| `apps/mobile/services/eveningReminderService.ts` | Created | Preferences CRUD, smart skip logic, stubbed notification scheduling |
| `apps/mobile/app/(tabs)/profile.tsx` | Modified | Added Evening Reminder settings section with toggle and time picker |
| `apps/mobile/app/_layout.tsx` | Modified | Added recordAppOpen() call on mount |

---

## QA Results
_(To be completed by QA Agent)_
