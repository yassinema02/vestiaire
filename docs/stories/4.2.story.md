# Story 4.2: AI Prompt Engineering & Integration

## Status

**Done**

---

## Story

**As a** system,
**I want** to generate outfit suggestions using Gemini AI,
**so that** recommendations are context-aware and stylish.

---

## Acceptance Criteria

1. Gemini API integrated via mobile service (existing API key available)
2. Prompt includes: wardrobe items, weather, calendar events
3. AI returns structured JSON: array of outfit suggestions with item IDs
4. Each suggestion includes: outfit name, occasion match, style rationale
5. Prompt optimized for token efficiency
6. Fallback response if AI fails (random matching items)
7. Context from Story 3.5 used for weather and calendar data

---

## Tasks / Subtasks

- [x] **Task 1: Create AI outfit service** (AC: 1, 2)
  - [x] Create `services/aiOutfitService.ts`
  - [x] Integrate with existing Gemini API key
  - [x] Format wardrobe items for AI consumption
  - [x] Include weather context from contextService
  - [x] Include calendar events context

- [x] **Task 2: Design prompt template** (AC: 2, 4, 5)
  - [x] Create base system prompt for fashion advice
  - [x] Define structured output format (JSON schema)
  - [x] Include user's wardrobe inventory
  - [x] Include weather and occasion context
  - [x] Optimize for token efficiency (50 items max)

- [x] **Task 3: Parse AI response** (AC: 3, 4)
  - [x] Parse JSON response from AI
  - [x] Validate item IDs exist in user's wardrobe
  - [x] Extract outfit name, occasion, rationale
  - [x] Handle malformed responses gracefully

- [x] **Task 4: Implement fallback logic** (AC: 6)
  - [x] Create fallback outfit generator
  - [x] Match items by category (top + bottom or dress)
  - [x] Return fallback when AI fails or times out

- [x] **Task 5: Create outfit generation hook** (AC: 1-7)
  - [x] Create `hooks/useOutfitGeneration.ts`
  - [x] Manage loading and error states
  - [x] Handle regeneration requests
  - [x] Save suggestions to outfit store

---

## Dev Notes

### Previous Story Insights
[Source: Story 3.5, Story 4.1]

**Context available from contextService:**
```typescript
const context = buildCurrentContext();
// Returns: OutfitContext with weather, events, primaryOccasion
```

**Wardrobe items from itemsService:**
```typescript
const { items } = await itemsService.getItems();
// Returns: WardrobeItem[] with category, colors, seasons, occasions
```

**Gemini API already configured:**
- `EXPO_PUBLIC_GEMINI_API_KEY` already in .env.local
- Used in `aiCategorization.ts` for item analysis

### Prompt Architecture

```
System: You are a professional fashion stylist...

User Input:
- Wardrobe: [list of items with id, category, color, seasons]
- Weather: 15°C, partly cloudy, need light layers
- Occasion: Work meeting at 10am, dinner with friends at 7pm
- Primary occasion: work

Expected Output (JSON):
{
  "suggestions": [
    {
      "name": "Professional Chic",
      "items": ["uuid-1", "uuid-2", "uuid-3"],
      "occasion": "work",
      "rationale": "Navy blazer pairs well with white shirt..."
    }
  ]
}
```

### Token Optimization
- Send only essential item properties (id, category, color, season)
- Limit items to 50 most recent if wardrobe is large
- Keep context concise

### File Locations

```
apps/mobile/
├── services/
│   └── aiOutfitService.ts    # NEW: AI outfit generation
├── hooks/
│   └── useOutfitGeneration.ts  # NEW: React hook for generation
├── utils/
│   └── outfitFallback.ts     # NEW: Fallback outfit logic
```

---

## Testing

### Test Cases

**AI Service:**
- Generates valid outfit suggestions with existing item IDs
- Handles network errors gracefully
- Times out after 30 seconds
- Fallback triggers when AI fails

**Prompt:**
- Context is properly formatted
- Wardrobe items are token-efficient
- Response matches expected JSON schema

**Edge Cases:**
- Wardrobe with < 5 items returns helpful message
- No matching items for weather falls back gracefully
- AI returns invalid item IDs are filtered out

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude (Anthropic) via Antigravity

### Debug Log References
TypeScript check passed (only pre-existing error in aiCategorization.ts)

### Completion Notes List
1. Created `services/aiOutfitService.ts` with Gemini 2.0 Flash integration
2. Built context-aware prompt using `formatContextForPrompt()` from Story 3.5
3. Token-optimized wardrobe formatting (max 50 items, essential props only)
4. Response validation filters invalid item IDs
5. Fallback generator creates simple matching outfits
6. Created `hooks/useOutfitGeneration.ts` for React components
7. Hook includes generate, regenerate, saveSuggestion, and clear functions
8. Weather context snapshot saved with AI-generated outfits

### File List

| File | Action | Description |
|------|--------|-------------|
| `services/aiOutfitService.ts` | NEW | Gemini AI outfit generation |
| `hooks/useOutfitGeneration.ts` | NEW | React hook for components |
