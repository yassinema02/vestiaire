# Story 1.3: CI/CD Pipeline to TestFlight

## Status

**Deferred** *(No Apple Developer account yet)*

---

## Story

**As a** developer,  
**I want** automated builds that deploy to TestFlight on every main branch push,  
**so that** testers always have access to the latest version.

---

## Acceptance Criteria

1. EAS Build configured for iOS with valid provisioning profile
2. GitHub Actions workflow triggers on push to `main` branch
3. Workflow runs EAS Build and submits to TestFlight automatically
4. Build secrets (Apple credentials, Supabase keys) stored securely in GitHub
5. Successful test: push to main â†’ build appears in TestFlight within 30 minutes
6. Build versioning increments automatically

---

## Tasks / Subtasks

- [ ] **Task 1: Configure EAS Build** (AC: 1)
  - [ ] Login to EAS: `npx eas login`
  - [ ] Initialize EAS: `npx eas build:configure`
  - [ ] Update `eas.json` with production profile settings
  - [ ] Configure iOS bundle identifier in `app.json` (already done: com.vestiaire.app)
  - [ ] Test local build config: `npx eas build --platform ios --profile production --local` (optional)

- [ ] **Task 2: Setup Apple Developer credentials** (AC: 1, 4)
  - [ ] Create/access Apple Developer account
  - [ ] Create App ID for com.vestiaire.app in Apple Developer Portal
  - [ ] Create provisioning profile for App Store distribution
  - [ ] Add Apple credentials to EAS: `npx eas credentials`
  - [ ] Verify credentials are valid

- [ ] **Task 3: Create GitHub Actions workflow** (AC: 2, 3)
  - [ ] Create `.github/workflows/eas-build.yml`
  - [ ] Configure trigger on push to `main` branch
  - [ ] Add checkout, node setup, and npm install steps
  - [ ] Add expo-github-action for EAS CLI
  - [ ] Add build and submit commands

- [ ] **Task 4: Configure GitHub secrets** (AC: 4)
  - [ ] Generate Expo access token at expo.dev
  - [ ] Add `EXPO_TOKEN` secret to GitHub repository
  - [ ] Add `EXPO_PUBLIC_SUPABASE_URL` secret
  - [ ] Add `EXPO_PUBLIC_SUPABASE_ANON_KEY` secret
  - [ ] Verify secrets are accessible in workflow

- [ ] **Task 5: Configure auto-versioning** (AC: 6)
  - [ ] Update `eas.json` to auto-increment build number
  - [ ] Configure `autoIncrement` in build profile
  - [ ] Test version increment locally

- [ ] **Task 6: Test complete pipeline** (AC: 5)
  - [ ] Push test commit to `main` branch
  - [ ] Verify GitHub Actions workflow triggers
  - [ ] Monitor build progress in EAS dashboard
  - [ ] Verify build submitted to TestFlight
  - [ ] Confirm build appears in TestFlight within 30 minutes

---

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 Completion Notes]
- Supabase project configured: `ynldmugsihrgwpvuvofu`
- Environment variables in `apps/mobile/.env.local`
- App bundleIdentifier: `com.vestiaire.app`

### EAS Configuration
[Source: architecture.md#deployment]

```json
// eas.json
{
  "cli": {
    "version": ">= 3.0.0"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal"
    },
    "preview": {
      "distribution": "internal"
    },
    "production": {
      "autoIncrement": true
    }
  },
  "submit": {
    "production": {
      "ios": {
        "appleId": "YOUR_APPLE_ID",
        "ascAppId": "YOUR_APP_STORE_CONNECT_APP_ID"
      }
    }
  }
}
```

### GitHub Actions Workflow
[Source: architecture.md#ci-cd-pipeline]

```yaml
# .github/workflows/eas-build.yml
name: EAS Build
on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - run: eas build --platform ios --profile production --non-interactive
      - run: eas submit --platform ios --latest --non-interactive
```

### File Locations
[Source: architecture.md#project-structure]

| File | Location |
|------|----------|
| EAS config | `apps/mobile/eas.json` |
| GitHub workflow | `.github/workflows/eas-build.yml` |
| App config | `apps/mobile/app.json` |

### Required Secrets
[Source: architecture.md#ci-cd-pipeline]

| Secret | Source | Purpose |
|--------|--------|---------|
| `EXPO_TOKEN` | expo.dev/accounts/settings | EAS CLI authentication |
| `EXPO_PUBLIC_SUPABASE_URL` | Supabase dashboard | App environment |
| `EXPO_PUBLIC_SUPABASE_ANON_KEY` | Supabase dashboard | App environment |

### Apple Developer Requirements

1. **Apple Developer Account** ($99/year) - Required for App Store/TestFlight
2. **App ID** - Register `com.vestiaire.app` in Developer Portal
3. **Provisioning Profile** - App Store Distribution profile
4. **App Store Connect App** - Create app entry for TestFlight

---

## Testing

### Testing Standards
[Source: architecture.md#testing-strategy]

- **Test Location:** N/A (infrastructure story)
- **Framework:** Manual verification
- **For this story:** End-to-end pipeline test

### Verification Steps

1. GitHub Actions workflow file exists at `.github/workflows/eas-build.yml`
2. Workflow triggers on push to `main`
3. EAS build starts successfully
4. Build submitted to TestFlight
5. Build available for testers within 30 minutes
6. Build number increments on each build

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
