# Story 6.5: Sustainability Score

## Status

**Implemented**

---

## Story

**As a** user,
**I want** to see my sustainability score,
**so that** I can track my eco-friendly fashion habits.

---

## Acceptance Criteria

1. Score calculated 0-100 based on wardrobe utilization
2. Factors: avg wear count, % items worn recently, CPW average
3. Score displayed on Analytics dashboard
4. Comparison: "Top 15% of Vestiaire users!"
5. Tips to improve score
6. Score recalculated weekly
7. Visual: leaf icon with score, color gradient

---

## Tasks / Subtasks

- [ ] **Task 1: Database Update** (AC: 1)
  - [ ] Create migration `vestiaire/supabase/migrations/011_sustainability_score.sql`
  - [ ] Add `sustainability_score` INTEGER DEFAULT 0 to `user_stats` table
  - [ ] Add `last_score_calc_date` DATE to `user_stats` table

- [ ] **Task 2: Score Calculation Logic** (AC: 1, 2, 6)
  - [ ] Update `vestiaire/apps/mobile/services/analyticsService.ts`
  - [ ] Add `calculateSustainabilityScore(userId: string): Promise<number>`
  - [ ] Implement Algorithm (Weighted Average):
    - **Utilization (40%)**: `(ActiveItems / TotalItems) * 100` (Active = worn in last 90 days)
    - **Wear Depth (30%)**: `(AvgWearCount / TargetWearCount) * 100` (Target ~30)
    - **Value Efficiency (30%)**: `(TargetCPW / AvgCPW) * 100` (Target ~Â£1)
    - Clamp result 0-100
  - [ ] Add `checkAndRecalculateScore(userId)`:
    - If `last_score_calc_date` < 7 days ago, return cached score.
    - Else, calculate, update DB, return new score.

- [ ] **Task 3: Comparative Stats (Mock)** (AC: 4)
  - [ ] *Note*: Real percentile requires analyzing *all* users. For MVP/Client-side only, we will mock this or use simple tiers.
  - [ ] Logic:
    - Score > 80: "Top 10%"
    - Score > 60: "Top 25%"
    - Score > 40: "Top 50%"
    - Else: "Improving"

- [ ] **Task 4: UI Implementation** (AC: 3, 5, 7)
  - [ ] Update `vestiaire/apps/mobile/app/(tabs)/analytics.tsx`
  - [ ] Create `SustainabilityCard` component
  - [ ] Visual: Ring Chart or Leaf Icon with Score
  - [ ] Color: Red (0-39) -> Yellow (40-69) -> Green (70-100)
  - [ ] Display "Comparison" text
  - [ ] Display "Tip":
    - If Utilization low: "Wear your neglected items!"
    - If CPW high: "Wear your expensive items more!"

- [ ] **Task 5: Testing**
  - [ ] Unit Test `calculateSustainabilityScore` with mock data scenarios
  - [ ] Manual Test: Verify score appears on Analytics tab
  - [ ] Manual Test: Verify "Recalculate" (change local date or force update)

---

## Dev Notes

### Architecture references
- **User Stats**: Stores the score.
- **Analytics Service**: Handles calculation (keeping `gamificationService` for points/badges).

### Technical Decisions
- **Calculation Frequency**: Weekly (on app open/analytics view), to save processing.
- **Comparison**: Hardcoded tiers for MVP as doing real-time percentile query on `user_stats` for every view is expensive/complex without a backend view or materialised view.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Initial story draft | Bob (SM) |
