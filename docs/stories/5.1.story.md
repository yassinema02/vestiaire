# Story 5.1: Wear Logging System

## Status

**Implemented**

---

## Story

**As a** user,  
**I want** to log which items I wear each day,  
**so that** the app can track my clothing usage.

---

## Acceptance Criteria

1. "Log Today's Outfit" button accessible from Home screen
2. Quick selection: tap items worn today from wardrobe grid
3. Or: select a saved outfit as "worn today"
4. Wear log stored: user_id, item_id, date, outfit_id (optional)
5. Can log multiple times per day (different occasions)
6. Can edit/delete past wear logs
7. Visual confirmation: "Logged! ðŸ‘—" animation

---

## Tasks / Subtasks

- [x] **Task 1: Create Wear Logs Database Schema** (AC: 4)
  - [x] Create Supabase migration `006_wear_logs_table.sql`
  - [x] Create `wear_logs` table with: id, user_id, item_id, outfit_id (nullable), worn_date, created_at
  - [x] Add foreign keys to items and outfits tables
  - [x] Add RLS policies for user access
  - [x] Add index on (user_id, worn_date) for efficient queries

- [x] **Task 2: Create Wear Logging Service** (AC: 4, 5, 6)
  - [x] Create `services/wearLogService.ts`
  - [x] Implement `logWear(itemIds: string[], outfitId?: string)` â€” creates wear log entries
  - [x] Implement `getWearLogsForDate(date: Date)` â€” returns logs for a specific date
  - [x] Implement `getWearCountForItem(itemId: string)` â€” returns total wear count
  - [x] Implement `deleteWearLog(logId: string)` â€” removes a wear log entry
  - [x] Implement `getRecentWearLogs(days: number)` â€” returns logs from last N days

- [x] **Task 3: Create TypeScript Types** (AC: 4)
  - [x] Add WearLog interface to `types/wearLog.ts`
  - [x] wear_count field already exists on WardrobeItem interface
  - [x] Types exported from types/wearLog.ts

- [x] **Task 4: Create Wear Log Screen** (AC: 1, 2, 3, 7)
  - [x] Create `app/(tabs)/log-wear.tsx` screen
  - [x] Add "Log Today's Outfit" button to Home screen
  - [x] Tab selector: "Select Items" vs "Log Saved Outfit"
  - [x] Grid view of wardrobe items with selectable checkmarks
  - [x] List of saved outfits as quick selection
  - [x] "Log Outfit" button (disabled until items selected)
  - [x] Success animation ("Logged!") on completion

- [x] **Task 5: Update Item Detail with Wear Count** (AC: 4)
  - [x] Wear count display already exists on item detail screen
  - [x] Last worn date already displayed
  - [x] Added "Worn N times - Last worn X days ago" summary in wear history

- [x] **Task 6: Implement Edit/Delete for Wear Logs** (AC: 6)
  - [x] Add wear history section to item detail
  - [x] Show list of dates item was worn
  - [x] Delete wear log entry via trash icon
  - [x] Confirmation dialog before delete

- [ ] **Task 7: Testing**
  - [ ] Test logging individual items
  - [ ] Test logging from saved outfit
  - [ ] Test multiple logs per day
  - [ ] Test delete wear log
  - [ ] Test wear count updates correctly

---

## Dev Notes

### Previous Epic Insights (from Epic 4)
- Item grid patterns exist in `builder.tsx` â€” reuse selection UI
- Outfit cards in `outfits.tsx` can be repurposed for outfit selection
- Success animations can use simple scale/fade with `Animated` API
- Tab patterns established in outfits screen

### Data Model

**WearLog Table:**
```sql
CREATE TABLE wear_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    item_id UUID NOT NULL REFERENCES wardrobe_items(id) ON DELETE CASCADE,
    outfit_id UUID REFERENCES outfits(id) ON DELETE SET NULL,
    worn_date DATE NOT NULL DEFAULT CURRENT_DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Composite unique constraint prevents duplicates
CREATE UNIQUE INDEX wear_logs_unique_item_date 
ON wear_logs(user_id, item_id, worn_date, outfit_id);

-- Index for efficient queries
CREATE INDEX wear_logs_user_date_idx ON wear_logs(user_id, worn_date);
```

### API Methods

**wearLogService.ts:**
```typescript
interface WearLog {
    id: string;
    user_id: string;
    item_id: string;
    outfit_id: string | null;
    worn_date: string; // YYYY-MM-DD
    created_at: string;
}

const wearLogService = {
    logWear(itemIds: string[], outfitId?: string): Promise<WearLog[]>;
    getWearLogsForDate(date: Date): Promise<WearLog[]>;
    getWearCountForItem(itemId: string): Promise<number>;
    deleteWearLog(logId: string): Promise<void>;
    getRecentWearLogs(days: number): Promise<WearLog[]>;
    getItemsWornToday(): Promise<string[]>;
};
```

### UI Components

| Component | Usage |
|-----------|-------|
| **ItemGrid** | Reuse from builder.tsx for item selection |
| **OutfitCard** | Horizontal list of saved outfits |
| **SuccessAnimation** | Checkmark + confetti animation |
| **WearHistoryList** | List of wear dates for an item |

**Design Colors (from front-end-spec.md):**
- Success green: `#7D9A78`
- Primary background: `#F5F0E8`
- Card background: `#FFFFFF`

### File Locations

| File | Path |
|------|------|
| Migration | `supabase/migrations/006_wear_logs_table.sql` |
| Service | `apps/mobile/services/wearLogService.ts` |
| Types | `apps/mobile/types/wearLog.ts` |
| Screen | `apps/mobile/app/(tabs)/log-wear.tsx` (or modal) |
| Home Update | `apps/mobile/app/(tabs)/index.tsx` |

### Dependencies on Other Stories

- Story 2.1: WardrobeItem model exists âœ…
- Story 4.1: Outfit model exists âœ…
- Story 4.5: Saved outfits available âœ…

### Future Stories Using This Data

- Story 5.3: Cost-Per-Wear â€” requires wear_count
- Story 5.4: Neglected Items â€” requires last_worn_date
- Story 5.7: Wear Calendar â€” requires wear_logs

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes List
- Created wear_logs table with triggers to auto-update item wear_count and last_worn_at
- Used `items` table (not `wardrobe_items` as in story draft) to match actual DB schema
- Used `upsert` in logWear to handle duplicate wear log entries gracefully
- Added "already worn today" badge on items in the log-wear grid
- Wear history section on item-detail shows up to 10 recent entries with delete option
- Success animation uses spring + fade with auto-dismiss and navigation back
- Also wired up Quick Actions buttons on Home screen (were previously missing onPress handlers)

### File List

| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/006_wear_logs_table.sql` | Created | Wear logs table with RLS, indexes, and triggers to sync item stats |
| `apps/mobile/types/wearLog.ts` | Created | WearLog and WearStats TypeScript interfaces |
| `apps/mobile/services/wearLogService.ts` | Created | Service with logWear, getWearLogsForDate, getWearCountForItem, deleteWearLog, getRecentWearLogs, getItemsWornToday, getWearHistoryForItem |
| `apps/mobile/app/(tabs)/log-wear.tsx` | Created | Full log-wear screen with item grid selection, saved outfit selection, category filters, success animation |
| `apps/mobile/app/(tabs)/_layout.tsx` | Modified | Registered log-wear route with href: null |
| `apps/mobile/app/(tabs)/index.tsx` | Modified | Added "Log Today's Outfit" button card and wired Quick Actions onPress handlers |
| `apps/mobile/app/(tabs)/item-detail.tsx` | Modified | Added wear history section with date list, relative date formatting, delete per entry |

---

## QA Results
_(To be completed by QA Agent)_
