# Story 2.2: Automatic Background Removal

## Status

**Done** ✅

---

## Story

**As a** user,  
**I want** the background automatically removed from my clothing photos,  
**so that** my wardrobe looks clean and professional.

---

## Acceptance Criteria

1. Background removal triggered automatically after upload
2. Processing indicator shown during removal (3-5 seconds)
3. Original and processed images both stored
4. Processed image displayed in wardrobe gallery
5. Fallback: if removal fails, original image used with notification
6. Integration with remove.bg API or Edge Function using rembg

---

## Tasks / Subtasks

- [x] **Task 1: Choose background removal solution** (AC: 6)
  - [x] Evaluate remove.bg API (paid, high quality)
  - [x] Evaluate rembg via Supabase Edge Function (free, self-hosted)
  - [x] Decision: Use remove.bg API (simpler integration, reliable)

- [x] **Task 2: Create background removal service** (AC: 1, 6)
  - [x] Create `services/backgroundRemoval.ts`
  - [x] Implement remove.bg API integration
  - [x] Handle API errors gracefully
  - [x] Add API key to environment variables

- [x] **Task 3: Integrate into upload flow** (AC: 1, 2)
  - [x] Trigger background removal after successful upload
  - [x] Show processing indicator in add screen
  - [x] Update item status to "processing" during removal

- [x] **Task 4: Store processed images** (AC: 3)
  - [x] Upload processed image to storage (separate path)
  - [x] Update item record with `processed_image_url`
  - [x] Keep original image as backup

- [x] **Task 5: Display processed images** (AC: 4)
  - [x] Update wardrobe to prefer `processed_image_url`
  - [x] Fall back to `image_url` if no processed version
  - [x] Add visual indicator for processing status

- [x] **Task 6: Handle failures gracefully** (AC: 5)
  - [x] If removal fails, use original image
  - [x] Show notification to user about fallback
  - [x] Log errors for debugging

---

## Dev Notes

### Previous Story Insights
[Source: Story 2.1 Completion Notes]
- Storage service at `services/storage.ts` handles uploads
- Items service at `services/items.ts` handles database
- Item has `processed_image_url` column ready
- Images stored at `wardrobe-images/{userId}/{timestamp}.jpg`

### Remove.bg API Integration
[Source: remove.bg documentation]

```typescript
// services/backgroundRemoval.ts
const REMOVE_BG_API_KEY = process.env.EXPO_PUBLIC_REMOVE_BG_API_KEY;
const REMOVE_BG_URL = 'https://api.remove.bg/v1.0/removebg';

export const removeBackground = async (imageUrl: string): Promise<{
  processedImageBase64: string | null;
  error: Error | null;
}> => {
  try {
    const formData = new FormData();
    formData.append('image_url', imageUrl);
    formData.append('size', 'auto');
    formData.append('format', 'png');
    
    const response = await fetch(REMOVE_BG_URL, {
      method: 'POST',
      headers: {
        'X-Api-Key': REMOVE_BG_API_KEY,
      },
      body: formData,
    });
    
    if (!response.ok) {
      throw new Error(`Remove.bg error: ${response.status}`);
    }
    
    const blob = await response.blob();
    // Convert to base64 for storage
    const base64 = await blobToBase64(blob);
    
    return { processedImageBase64: base64, error: null };
  } catch (error) {
    console.error('Background removal error:', error);
    return { processedImageBase64: null, error: error as Error };
  }
};
```

### Environment Variables
```
EXPO_PUBLIC_REMOVE_BG_API_KEY=your_api_key_here
```

### Alternative: Supabase Edge Function with rembg
If we want a free solution later, we can create a Supabase Edge Function using the `rembg` Python library. This requires more setup but has no API costs.

---

## Testing

### Test Cases

1. **Background Removal Success**
   - Upload image → processing indicator shown
   - After processing → item shows transparent background
   - Original and processed URLs both stored

2. **Background Removal Failure**
   - Simulate API error → original image used
   - User sees fallback notification
   - Item still usable

3. **Wardrobe Display**
   - Items with processed images show clean background
   - Items without processed images show original

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
