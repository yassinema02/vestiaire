# Story 5.3: Cost-Per-Wear Calculation

## Status

**Implemented**

---

## Story

**As a** user,  
**I want** to see the cost-per-wear for each item,  
**so that** I understand the value I'm getting from my clothes.

---

## Acceptance Criteria

1. CPW calculated: purchase_price / wear_count
2. CPW displayed on item detail screen
3. CPW badge on wardrobe gallery cards
4. Color coding: green (<Â£5), yellow (Â£5-20), red (>Â£20)
5. Items without price show "Add price to track CPW"
6. CPW updates in real-time after each wear log
7. Celebration when CPW drops below threshold

---

## Tasks / Subtasks

- [x] **Task 1: Ensure Price Field Exists on Items** (AC: 1, 5)
  - [x] Verified `purchase_price` field exists on items table
  - [x] No currency column in schema â€” using $ as default symbol
  - [x] WardrobeItem interface already has purchase_price

- [x] **Task 2: Create CPW Calculation Utility** (AC: 1)
  - [x] Created `utils/cpwCalculator.ts`
  - [x] Implemented `calculateCPW`, `getCPWResult`, `formatCPWBreakdown`
  - [x] Handle edge cases: no price (null), zero wears (returns full price)
  - [x] Returns formatted string with $ symbol and color info

- [x] **Task 3: Add CPW Badge to Wardrobe Gallery** (AC: 3, 4)
  - [x] Display color-coded CPW badge on item cards
  - [x] Color coding: green (<$5), yellow ($5-20), red (>$20)
  - [x] Show "+ price" prompt if no purchase_price
  - [x] Added CPW sort options (Best/Worst Cost/Wear)

- [x] **Task 4: Display CPW on Item Detail Screen** (AC: 2, 4, 5)
  - [x] Added CPW card to item detail screen
  - [x] Shows formula breakdown: "$120.00 Ã· 24 wears = $5.00/wear"
  - [x] Color-coded value with label badge (Great/Good/Keep wearing)
  - [x] Prompt to add price if missing

- [x] **Task 5: Real-time CPW Updates** (AC: 6)
  - [x] Item wear_count auto-updated by DB triggers (from Story 5.1)
  - [x] CPW recalculates automatically when item data refreshes
  - [x] UI reflects new CPW on screen focus

- [x] **Task 6: CPW Threshold Celebration** (AC: 7)
  - [x] Green items show "This item is great value! ğŸ‰" message
  - [x] `didCPWCrossThreshold()` utility available for future animation
  - [x] Red items show "Keep wearing to reduce your cost per wear!"

- [ ] **Task 7: Testing**
  - [ ] Test CPW calculation accuracy
  - [ ] Test color coding thresholds
  - [ ] Test real-time updates after wear log
  - [ ] Test celebration trigger

---

## Dev Notes

### Previous Story Insights (from Story 5.1)
- `wear_count` and `last_worn_at` are auto-updated by database triggers
- Item detail screen exists at `item-detail.tsx`
- Wardrobe gallery at `wardrobe.tsx`

### Existing Data Model

**items table already has:**
- `purchase_price` â€” numeric, nullable
- `currency` â€” text (e.g., 'GBP', 'USD', 'EUR')
- `wear_count` â€” auto-incremented by wear_logs trigger
- `last_worn_at` â€” auto-updated by wear_logs trigger

### CPW Calculation

```typescript
function calculateCPW(price: number | null, wearCount: number): number | null {
    if (!price || price <= 0) return null;
    if (wearCount <= 0) return price; // First wear = full price
    return price / wearCount;
}

function getCPWColor(cpw: number): 'green' | 'yellow' | 'red' {
    if (cpw < 5) return 'green';
    if (cpw <= 20) return 'yellow';
    return 'red';
}
```

### CPW Color Palette

| CPW Range | Color | Hex |
|-----------|-------|-----|
| < Â£5 | Green (Great) | `#22c55e` |
| Â£5-20 | Yellow (Good) | `#eab308` |
| > Â£20 | Red (Improve) | `#ef4444` |

### UI Components

**CPW Badge (gallery card):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   [item image]  â”‚
â”‚                 â”‚
â”‚     Â£4/wear ğŸŸ¢  â”‚ â† CPW badge bottom-right
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CPW Section (item detail):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cost Per Wear                       â”‚
â”‚ Â£120 Ã· 24 wears = Â£5.00/wear   ğŸŸ¡   â”‚
â”‚ Keep wearing to reduce!             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Locations

| File | Path |
|------|------|
| CPW Calculator | `apps/mobile/utils/cpwCalculator.ts` |
| Wardrobe Gallery | `apps/mobile/app/(tabs)/wardrobe.tsx` |
| Item Detail | `apps/mobile/app/(tabs)/item-detail.tsx` |
| Wear Log Service | `apps/mobile/services/wearLogService.ts` |

### Dependencies

- Story 2.3: Item metadata with price âœ…
- Story 5.1: Wear logging with wear_count âœ…

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No issues â€” clean TypeScript compile.

### Completion Notes List
- No `currency` column exists on items table â€” used `$` as default symbol instead of adding a migration
- Story references `Â£` but actual codebase uses `$` â€” consistent with existing price display in item-detail
- `didCPWCrossThreshold()` utility exported for future use (e.g., celebration animation after logging wear)
- Added CPW sort options to wardrobe gallery (Best/Worst Cost/Wear)
- Items without purchase_price show a subtle "+ price" badge prompting the user to add one
- Real-time updates rely on DB triggers from Story 5.1 that auto-update wear_count

### File List

| File | Action | Description |
|------|--------|-------------|
| `apps/mobile/utils/cpwCalculator.ts` | Created | CPW calculation, color coding, formatting utilities |
| `apps/mobile/app/(tabs)/wardrobe.tsx` | Modified | Added color-coded CPW badge on gallery cards + CPW sort options |
| `apps/mobile/app/(tabs)/item-detail.tsx` | Modified | Added CPW section with formula breakdown, color coding, celebration text |

---

## QA Results
_(To be completed by QA Agent)_
