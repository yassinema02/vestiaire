# Story 2.3: Auto-Categorization & Color Detection

## Status

**Done** ✅

---

## Story

**As a** user,  
**I want** my clothing items automatically categorized and color-detected,  
**so that** I don't have to manually tag everything.

---

## Acceptance Criteria

1. AI analyzes image and suggests category (tops, bottoms, shoes, outerwear, accessories)
2. Dominant color(s) extracted and assigned to item
3. Suggestions presented to user for confirmation/editing
4. User can override AI suggestions with manual selection
5. Category and color stored in database with item record
6. Sub-categories available (e.g., tops → t-shirt, blouse, sweater)

---

## Tasks / Subtasks

- [x] **Task 1: Choose AI solution for categorization** (AC: 1, 6)
  - [x] Evaluate Google Gemini Vision API
  - [x] Evaluate OpenAI GPT-4 Vision
  - [x] Decision: Use Gemini (free tier, good accuracy, Google ecosystem)

- [x] **Task 2: Create AI categorization service** (AC: 1, 6)
  - [x] Create `services/aiCategorization.ts`
  - [x] Implement Gemini Vision API integration
  - [x] Define category and sub-category taxonomy
  - [x] Add API key to environment variables

- [x] **Task 3: Implement color detection** (AC: 2)
  - [x] Extract dominant colors using AI
  - [x] Support multiple colors per item
  - [x] Define color palette (21 colors)

- [x] **Task 4: Create confirmation/edit UI** (AC: 3, 4)
  - [x] Create post-upload screen showing AI suggestions
  - [x] Display category picker with AI pre-selection
  - [x] Display color picker with detected colors highlighted
  - [x] Add "Confirm" and "Skip" buttons

- [x] **Task 5: Update database with metadata** (AC: 5)
  - [x] Save category, sub_category, and colors to item record
  - [x] Update item status from "pending" to "complete"

- [x] **Task 6: Integrate into upload flow** (AC: 1-6)
  - [x] After background removal, navigate to confirmation
  - [x] Use processed image for AI analysis
  - [x] Save metadata on confirmation

---

## Dev Notes

### Previous Story Insights
[Source: Story 2.2 Completion]
- Background removal using remove.bg API working
- Items have `category`, `sub_category`, `colors` columns ready
- Upload flow in `app/(tabs)/add.tsx` can be extended

### Category Taxonomy

```typescript
const CATEGORIES = {
  tops: ['t-shirt', 'shirt', 'blouse', 'sweater', 'hoodie', 'tank-top', 'polo'],
  bottoms: ['jeans', 'pants', 'shorts', 'skirt', 'leggings', 'sweatpants'],
  dresses: ['casual-dress', 'formal-dress', 'maxi-dress', 'mini-dress'],
  outerwear: ['jacket', 'coat', 'blazer', 'cardigan', 'vest'],
  shoes: ['sneakers', 'boots', 'heels', 'sandals', 'loafers', 'flats'],
  accessories: ['bag', 'hat', 'scarf', 'belt', 'jewelry', 'watch'],
};
```

### Color Palette

```typescript
const COLORS = [
  { name: 'Black', hex: '#000000' },
  { name: 'White', hex: '#FFFFFF' },
  { name: 'Gray', hex: '#808080' },
  { name: 'Navy', hex: '#000080' },
  { name: 'Blue', hex: '#0000FF' },
  { name: 'Light Blue', hex: '#ADD8E6' },
  { name: 'Red', hex: '#FF0000' },
  { name: 'Burgundy', hex: '#800020' },
  { name: 'Pink', hex: '#FFC0CB' },
  { name: 'Orange', hex: '#FFA500' },
  { name: 'Yellow', hex: '#FFFF00' },
  { name: 'Green', hex: '#008000' },
  { name: 'Olive', hex: '#808000' },
  { name: 'Brown', hex: '#A52A2A' },
  { name: 'Tan', hex: '#D2B48C' },
  { name: 'Cream', hex: '#FFFDD0' },
  { name: 'Purple', hex: '#800080' },
];
```

### Gemini Vision API Integration

```typescript
// services/aiCategorization.ts
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(API_KEY);
const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

const prompt = `Analyze this clothing item image and provide:
1. Main category (one of: tops, bottoms, dresses, outerwear, shoes, accessories)
2. Sub-category (specific type like t-shirt, jeans, sneakers, etc.)
3. Primary color(s) (up to 3 main colors)
4. Pattern (solid, striped, plaid, floral, etc.)

Respond in JSON format:
{
  "category": "tops",
  "subCategory": "t-shirt",
  "colors": ["Black", "White"],
  "pattern": "solid"
}`;
```

### Environment Variables
```
EXPO_PUBLIC_GEMINI_API_KEY=your_api_key_here
```

---

## Testing

### Test Cases

1. **Category Detection Accuracy**
   - Upload various clothing types
   - Verify correct category/sub-category suggestions
   - Test edge cases (patterned items, unusual colors)

2. **Color Detection**
   - Test single-color items
   - Test multi-color items
   - Verify color names match palette

3. **User Override**
   - Change AI suggestions before confirming
   - Verify changes saved to database

4. **Flow Integration**
   - Full flow: capture → upload → bg removal → categorization → confirm
   - Verify all data saved correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-24 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

---

## QA Results
*To be filled by QA agent*
