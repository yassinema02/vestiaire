# Story 3.1: User Location & Weather Display

## Status

**Done**

---

## Story

**As a** user,
**I want** to see current weather conditions for my location,
**so that** I can understand why certain outfits are recommended.

---

## Acceptance Criteria

1. App requests location permission on first use with clear explanation
2. Current location used to fetch weather data
3. Weather widget on Home screen shows: temperature, condition icon, "feels like"
4. Weather updates automatically when app opens (cached for 30 minutes)
5. Manual location override option in settings
6. Graceful fallback if location denied (manual city entry)
7. Integration with Open-Meteo API (free, no API key required)

---

## Tasks / Subtasks

- [x] **Task 1: Create weather service** (AC: 2, 7)
  - [x] Create `apps/mobile/services/weather.ts`
  - [x] Implement Open-Meteo API integration (free tier, no API key)
  - [x] Define weather response types matching Open-Meteo schema
  - [x] Add weather condition code to icon/description mapping
  - [x] Implement error handling for API failures

- [x] **Task 2: Implement location service** (AC: 1, 2)
  - [x] Create `apps/mobile/services/location.ts`
  - [x] Add `expo-location` package to dependencies
  - [x] Request foreground location permission with explanation message
  - [x] Get current coordinates (latitude, longitude)
  - [x] Handle permission denied gracefully

- [x] **Task 3: Create weather store** (AC: 4)
  - [x] Create `apps/mobile/stores/weatherStore.ts` using Zustand
  - [x] Store current weather data, location, and last fetch timestamp
  - [x] Implement 30-minute cache logic (skip fetch if cached)
  - [x] Add `refreshWeather()` action that checks cache before fetching
  - [x] Persist weather data to AsyncStorage for offline access

- [x] **Task 4: Build weather widget component** (AC: 3)
  - [x] Create `apps/mobile/components/features/WeatherWidget.tsx`
  - [x] Display current temperature (°C)
  - [x] Show weather condition icon (use Ionicons weather icons)
  - [x] Display "feels like" temperature
  - [x] Show location name (city)
  - [x] Add loading skeleton state
  - [x] Add error state with retry button

- [x] **Task 5: Integrate weather widget on Home screen** (AC: 3, 4)
  - [x] Update `apps/mobile/app/(tabs)/index.tsx`
  - [x] Add WeatherWidget to Home screen header area
  - [x] Trigger weather refresh on screen focus (respecting cache)
  - [x] Handle loading and error states gracefully

- [x] **Task 6: Implement location fallback** (AC: 5, 6)
  - [x] Create manual city search/entry component
  - [x] Store user's preferred location override in AsyncStorage
  - [x] Add "Change Location" option to settings or weather widget
  - [x] Use geocoding to convert city name to coordinates
  - [x] Fall back to manual entry when location permission denied

- [x] **Task 7: Add location settings** (AC: 5)
  - [x] Add location preference section to Profile/Settings screen
  - [x] Option to use device location or manual override
  - [x] Display currently selected location
  - [x] Allow user to reset to device location

---

## Dev Notes

### Previous Story Insights
[Source: Story 2.7]
- Root layout (`_layout.tsx`) handles auth state and onboarding routing
- Zustand stores pattern established in `stores/authStore.ts`
- Services follow pattern established in `services/items.ts`, `services/onboarding.ts`
- Home screen exists at `apps/mobile/app/(tabs)/index.tsx` - currently shows placeholder content

### Weather API Specification
[Source: architecture.md#External APIs]

**Open-Meteo API** (Free tier, no API key required):
```
Base URL: https://api.open-meteo.com/v1/forecast
```

**Request:**
```typescript
// GET https://api.open-meteo.com/v1/forecast?latitude=52.52&longitude=13.41&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m
```

**Response:**
```typescript
interface OpenMeteoResponse {
  latitude: number;
  longitude: number;
  current: {
    time: string;
    temperature_2m: number;        // Current temp in °C
    apparent_temperature: number;   // Feels like in °C
    relative_humidity_2m: number;   // Humidity %
    weather_code: number;           // WMO weather code
    wind_speed_10m: number;         // Wind in km/h
  };
  current_units: {
    temperature_2m: string;
    apparent_temperature: string;
  };
}
```

### Weather Code Mapping
WMO Weather interpretation codes:
| Code | Description | Icon |
|------|-------------|------|
| 0 | Clear sky | sunny |
| 1,2,3 | Mainly clear, partly cloudy | partly-sunny |
| 45,48 | Fog | cloud |
| 51,53,55 | Drizzle | rainy |
| 61,63,65 | Rain | rainy |
| 71,73,75 | Snow | snow |
| 80,81,82 | Rain showers | thunderstorm |
| 95,96,99 | Thunderstorm | thunderstorm |

### Data Models
[Source: architecture.md#Data Models]

```typescript
// Weather context for AI outfit generation (used in Epic 4)
interface WeatherContext {
  temp: number;           // Current temperature °C
  feels_like: number;     // Apparent temperature °C
  condition: string;      // Weather condition (clear, cloudy, rain, etc.)
  humidity: number;       // Relative humidity %
  wind_speed: number;     // Wind speed km/h
  weather_code: number;   // WMO code for detailed mapping
}

// Location data
interface UserLocation {
  latitude: number;
  longitude: number;
  city: string | null;
  isManual: boolean;      // true if user manually set location
}

// Weather store state
interface WeatherState {
  weather: WeatherContext | null;
  location: UserLocation | null;
  lastFetched: number | null;  // timestamp
  isLoading: boolean;
  error: string | null;
}
```

### File Locations
[Source: architecture.md#Project Structure]

```
apps/mobile/
├── services/
│   └── weather.ts           # NEW: Weather API service
│   └── location.ts          # NEW: Location service
├── stores/
│   └── weatherStore.ts      # NEW: Weather Zustand store
├── components/
│   └── features/
│       └── WeatherWidget.tsx # NEW: Weather display component
├── app/
│   └── (tabs)/
│       └── index.tsx        # UPDATE: Add weather widget
│       └── profile.tsx      # UPDATE: Add location settings
```

### Dependencies Required
```json
{
  "expo-location": "~17.0.1"  // For device location access
}
```

Install: `npx expo install expo-location`

### Location Permission Message
iOS requires explanation for location usage:
```json
// app.json
{
  "expo": {
    "ios": {
      "infoPlist": {
        "NSLocationWhenInUseUsageDescription": "Vestiaire uses your location to show local weather and provide weather-appropriate outfit recommendations."
      }
    }
  }
}
```

### Cache Strategy
[Source: architecture.md#Performance]

```typescript
const WEATHER_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

const shouldRefreshWeather = (lastFetched: number | null): boolean => {
  if (!lastFetched) return true;
  return Date.now() - lastFetched > WEATHER_CACHE_DURATION;
};
```

### Error Handling
- Network errors: Show cached data with "offline" indicator
- API errors: Show generic error with retry button
- Location denied: Prompt for manual city entry
- Invalid coordinates: Fall back to default location or prompt user

### Coding Standards
[Source: architecture.md#Coding Standards]

- Use TypeScript strict mode
- Service functions return `{ data, error }` pattern (established in items service)
- Zustand store with actions pattern (established in authStore)
- NativeWind for styling (Tailwind classes)
- Use Ionicons for weather icons

---

## Testing

### Test File Location
`apps/mobile/__tests__/services/weather.test.ts`
`apps/mobile/__tests__/stores/weatherStore.test.ts`

### Test Cases

**Weather Service:**
- Successfully fetches weather data from Open-Meteo
- Maps weather codes to conditions correctly
- Handles network errors gracefully
- Returns null/error for invalid coordinates

**Location Service:**
- Requests permission correctly
- Returns coordinates when granted
- Returns error when denied
- Handles timeout scenarios

**Weather Store:**
- Initializes with null weather
- Fetches and stores weather correctly
- Respects 30-minute cache
- Forces refresh when cache expired
- Persists to AsyncStorage

**Weather Widget:**
- Renders loading state
- Displays temperature and icon
- Shows error state with retry
- Updates on weather change

### Manual Testing
- Fresh install: Location permission prompt appears
- Grant permission: Weather loads and displays
- Deny permission: Manual city entry shown
- Kill app and reopen within 30 min: Uses cached weather
- Kill app and reopen after 30 min: Fetches fresh weather
- Enable airplane mode: Shows cached weather with offline indicator

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story draft | Bob (SM) |
| 2026-01-26 | 1.1 | Implementation complete | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Build validated via `npx expo export --platform ios`
- Pre-existing TypeScript type conflicts in aiCategorization.ts (unrelated to this story)

### Completion Notes List
1. Created weather service with Open-Meteo API integration (free, no API key)
2. Created location service with expo-location for device GPS and geocoding
3. Created weatherStore with Zustand following authStore pattern
4. Implemented 30-minute cache with AsyncStorage persistence
5. Built WeatherWidget component with loading, error, and manual city entry states
6. Integrated weather widget on Home screen with focus-based refresh
7. Added location settings section to Profile screen
8. Updated app.config.js with iOS and Android location permissions
9. Installed expo-location package

### File List

**Created:**
- `apps/mobile/services/weather.ts` - Weather API service
- `apps/mobile/services/location.ts` - Location/geocoding service
- `apps/mobile/stores/weatherStore.ts` - Zustand weather store
- `apps/mobile/components/features/WeatherWidget.tsx` - Weather display component

**Modified:**
- `apps/mobile/app/(tabs)/index.tsx` - Added WeatherWidget to Home screen
- `apps/mobile/app/(tabs)/profile.tsx` - Added location settings section
- `apps/mobile/app.config.js` - Added location permissions and expo-location plugin
