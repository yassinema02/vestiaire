# Story 3.4: Apple Calendar (EventKit) Integration

## Status

**Done**

---

## Story

**As a** user,
**I want** to use my iPhone's built-in calendar,
**so that** I don't need to connect external services.

---

## Acceptance Criteria

1. "Use iPhone Calendar" option in settings
2. EventKit permission requested with explanation
3. Today's events from all calendars displayed on Home
4. User can select which calendars to include
5. Same display format as Google Calendar events
6. Works alongside or instead of Google Calendar

---

## Tasks / Subtasks

- [x] **Task 1: Install and configure expo-calendar** (AC: 2)
  - [x] Install `expo-calendar` package via `npx expo install expo-calendar`
  - [x] Update `app.config.js` to add expo-calendar plugin
  - [x] Add `NSCalendarsUsageDescription` to iOS infoPlist

- [x] **Task 2: Create Apple Calendar service** (AC: 2, 3, 4)
  - [x] Create `apps/mobile/services/appleCalendar.ts`
  - [x] Implement `requestPermission()` function using expo-calendar
  - [x] Implement `checkPermission()` to verify current status
  - [x] Implement `getCalendars()` to list all device calendars
  - [x] Implement `fetchTodayEvents(calendarIds)` to get today's events
  - [x] Implement calendar selection storage using AsyncStorage
  - [x] Reuse `CalendarEvent` interface from `services/calendar.ts`
  - [x] Apply `detectOccasion()` from `utils/occasionDetector.ts` to event titles

- [x] **Task 3: Refactor calendar store for multi-source support** (AC: 5, 6)
  - [x] Update `apps/mobile/stores/calendarStore.ts`
  - [x] Add state fields: `appleConnected`, `appleSelectedCalendars`
  - [x] Add actions: `connectApple()`, `disconnectApple()`, `setAppleCalendars()`
  - [x] Add action: `getAvailableAppleCalendars()`
  - [x] Update `refreshEvents()` to fetch from both Google and Apple sources
  - [x] Implement event merging logic (combine + sort by start time)
  - [x] Update `isConnected` to be true if either source connected
  - [x] Add optional `source: 'google' | 'apple'` field to `CalendarEvent`

- [x] **Task 4: Create CalendarSelector component** (AC: 4)
  - [x] Create `apps/mobile/components/features/CalendarSelector.tsx`
  - [x] Implement modal with list of available Apple calendars
  - [x] Show calendar name and color indicator
  - [x] Add checkbox for each calendar selection
  - [x] Add "Select All" / "Deselect All" buttons
  - [x] Emit selection changes to parent component

- [x] **Task 5: Update Profile screen with Apple Calendar section** (AC: 1, 4, 6)
  - [x] Update `apps/mobile/app/(tabs)/profile.tsx`
  - [x] Add "iPhone Calendar" card below existing Google Calendar card
  - [x] Show connection status (connected with X calendars / not connected)
  - [x] Add "Connect" / "Disconnect" button for Apple Calendar
  - [x] Add "Select Calendars" button when connected
  - [x] Integrate CalendarSelector modal

- [x] **Task 6: Update EventsWidget for multi-source** (AC: 5, 6)
  - [x] Update `apps/mobile/components/features/EventsWidget.tsx`
  - [x] Update "Connect Calendar" prompt to mention both options
  - [x] Optionally add small source indicator icon on events

---

## Dev Notes

### Previous Story Insights
[Source: Story 3.3 Completion Notes]

- Calendar infrastructure already established:
  - `services/calendar.ts` - Google OAuth and Calendar API service
  - `stores/calendarStore.ts` - Zustand store with events, connection status, caching
  - `components/features/EventsWidget.tsx` - Events display with occasion badges
  - `utils/occasionDetector.ts` - 5 occasion types: work, social, formal, sport, casual
- Packages installed: expo-auth-session, expo-web-browser, expo-crypto, expo-secure-store
- 15-minute event cache duration implemented
- EventsWidget integrated on Home screen below ForecastWidget
- Profile has "Connected Calendars" section with Google OAuth flow

### Data Models
[Source: architecture.md#Data Models]

Reuse existing `CalendarEvent` interface from `services/calendar.ts`:

```typescript
interface CalendarEvent {
  id: string;
  title: string;
  startTime: string;         // ISO string or "All day"
  endTime: string;
  location: string | null;
  isAllDay: boolean;
  occasion: OccasionType;    // from occasionDetector.ts
  source?: 'google' | 'apple';  // NEW: optional source indicator
}

type OccasionType = 'work' | 'social' | 'formal' | 'sport' | 'casual';
```

New interface for Apple Calendar metadata:

```typescript
interface AppleCalendar {
  id: string;
  title: string;
  color: string;             // hex color
  source: string;            // iCloud, Local, etc.
  isPrimary: boolean;
  allowsModifications: boolean;
}
```

### expo-calendar API Reference
[Source: Expo Documentation]

```typescript
import * as Calendar from 'expo-calendar';

// Request permissions
const { status } = await Calendar.requestCalendarPermissionsAsync();

// Get all calendars
const calendars = await Calendar.getCalendarsAsync(Calendar.EntityTypes.EVENT);

// Get events in date range
const events = await Calendar.getEventsAsync(
  calendarIds,           // string[]
  startDate,             // Date
  endDate                // Date
);

// Event object from expo-calendar
interface CalendarEventNative {
  id: string;
  calendarId: string;
  title: string;
  startDate: string;     // ISO timestamp
  endDate: string;
  allDay: boolean;
  location?: string;
  notes?: string;
}
```

### File Locations
[Source: architecture.md#Project Structure]

```
apps/mobile/
├── services/
│   ├── calendar.ts              # Existing (Google)
│   └── appleCalendar.ts         # NEW: Apple/EventKit service
├── stores/
│   └── calendarStore.ts         # MODIFY: Multi-source support
├── components/
│   └── features/
│       ├── EventsWidget.tsx     # MODIFY: Minor updates
│       └── CalendarSelector.tsx # NEW: Calendar picker modal
├── app/
│   └── (tabs)/
│       └── profile.tsx          # MODIFY: Apple Calendar section
└── app.config.js                # MODIFY: expo-calendar plugin
```

### app.config.js Updates Required
[Source: architecture.md#Project Structure]

Add to `ios.infoPlist`:
```javascript
NSCalendarsUsageDescription: 'Vestiaire needs access to your calendar to show upcoming events and suggest appropriate outfits.',
```

Add to `plugins` array:
```javascript
[
  'expo-calendar',
  {
    calendarPermission: 'Vestiaire needs access to your calendar to show upcoming events and suggest appropriate outfits.',
  },
],
```

### Coding Standards
[Source: architecture.md#Coding Standards]

- **Type Sharing:** Import types from existing calendar.ts
- **API Calls:** Use service layer pattern (appleCalendar.ts)
- **State:** Use Zustand stores with actions pattern
- **Error Handling:** Return `{ data, error }` pattern from service functions
- **Storage:** Use AsyncStorage for calendar selection (not sensitive data)

### Security Considerations
[Source: architecture.md#Security]

- Calendar selection is NOT sensitive (unlike OAuth tokens)
- Store selected calendar IDs in AsyncStorage, not SecureStore
- Only read calendar events, never write
- Clear selection on disconnect

### EventKit Limitation

> **IMPORTANT:** EventKit does NOT work in Expo Go. Testing requires a development build:
> ```bash
> npx expo run:ios
> ```

---

## Testing

### Test File Location

`apps/mobile/__tests__/services/appleCalendar.test.ts`
`apps/mobile/__tests__/stores/calendarStore.test.ts` (update existing)

### Test Standards
[Source: architecture.md#Testing Strategy]

- Use Jest + React Native Testing Library
- Follow test pyramid: Unit → Integration → E2E
- Test organization: `apps/mobile/__tests__/{type}/{filename}.test.ts`

### Test Cases

**Apple Calendar Service:**
- Permission request returns correct status
- `getCalendars()` returns array of calendars
- `fetchTodayEvents()` returns events with correct format
- Events have occasion detected correctly
- Handles empty calendar list gracefully
- Calendar selection persists across sessions

**Calendar Store (Multi-Source):**
- `connectApple()` requests permission and loads calendars
- `disconnectApple()` clears selection and Apple events
- `refreshEvents()` fetches from both sources when both connected
- Events properly merged and sorted by start time
- `isConnected` true when only Apple connected
- `isConnected` true when only Google connected
- `isConnected` true when both connected
- `isConnected` false when neither connected

**CalendarSelector Component:**
- Renders list of available calendars
- Calendar color indicators displayed correctly
- Checkbox toggles work correctly
- "Select All" selects all calendars
- "Deselect All" clears selection
- Selection callback fires with correct IDs

### Manual Testing

1. Request permission when connecting iPhone Calendar
2. Verify permission dialog appears with custom message
3. Grant permission and verify calendars load
4. Select subset of calendars and verify only those events appear
5. Verify events display with correct occasion badges
6. Test with both Google and Apple connected simultaneously
7. Disconnect Apple, verify Google events still show
8. Close and reopen app, verify Apple selection persisted

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude (Anthropic) via Antigravity

### Debug Log References
N/A - No blocking issues encountered

### Completion Notes List
- Successfully installed `expo-calendar` and configured iOS permissions
- Created comprehensive `appleCalendar.ts` service with full EventKit integration
- Refactored `calendarStore.ts` to support dual calendar sources (Google + Apple)
- Created `CalendarSelector.tsx` modal with Select All/Deselect All functionality
- Updated Profile screen with iPhone Calendar section including connect/disconnect/select buttons
- Added source indicator dots to EventsWidget (blue for Google, Apple blue for Apple)
- All TypeScript types properly aligned between services and store
- Pre-existing linting issue in `aiCategorization.ts` unrelated to this story

### File List

| File | Action | Description |
|------|--------|-------------|
| `apps/mobile/services/appleCalendar.ts` | NEW | Apple Calendar service with EventKit integration |
| `apps/mobile/stores/calendarStore.ts` | MODIFIED | Multi-source support with Google + Apple |
| `apps/mobile/components/features/CalendarSelector.tsx` | NEW | Calendar selection modal |
| `apps/mobile/app/(tabs)/profile.tsx` | MODIFIED | Added Apple Calendar section |
| `apps/mobile/components/features/EventsWidget.tsx` | MODIFIED | Added source indicator, fixed import |
| `apps/mobile/app.config.js` | MODIFIED | Added expo-calendar plugin and iOS permissions |
