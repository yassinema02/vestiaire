# Story 7.5: Freemium Tier Limits

## Status

**Done**

---

## Story

**As a** system,  
**I want** to enforce usage limits for free users,  
**so that** premium subscriptions have clear value.

---

## Acceptance Criteria

1. Free tier: 3 AI outfit suggestions per day
2. Free tier: 2 resale listings per month
3. Usage counters displayed in app (e.g., "2/3 suggestions today")
4. Soft paywall when limit reached: "Upgrade for unlimited"
5. Countdown timer: "Refreshes in 12 hours" or "Resets Feb 15"
6. Limits stored in database, reset on schedule
7. Premium users: unlimited everything (bypass all checks)

---

## Tasks / Subtasks

- [ ] **Task 1: Create User Stats Schema** (AC: 6)
  - [ ] Create migration `014_user_stats.sql`
  - [ ] Create `user_stats` table with: user_id, ai_suggestions_today, ai_suggestions_reset_at, resale_listings_month, resale_listings_reset_at, is_premium
  - [ ] Add RLS policies
  - [ ] Add trigger to create stats row on user signup

- [ ] **Task 2: Create Usage Tracking Service** (AC: 1, 2, 6)
  - [ ] Create `services/usageLimitsService.ts`
  - [ ] Implement `checkAISuggestionLimit()` â€” returns { allowed, remaining, resetAt }
  - [ ] Implement `incrementAISuggestions()` â€” increments counter
  - [ ] Implement `checkResaleListingLimit()` â€” returns { allowed, remaining, resetAt }
  - [ ] Implement `incrementResaleListings()` â€” increments counter
  - [ ] Implement `resetDailyLimits()` and `resetMonthlyLimits()` (cron or edge function)

- [ ] **Task 3: Integrate Limits into AI Outfit Generation** (AC: 1, 4, 5)
  - [ ] Check limit before generating outfit in outfitService
  - [ ] Show paywall modal if limit reached
  - [ ] Display usage counter on outfit screen: "2/3 suggestions today"
  - [ ] Show countdown timer to next reset

- [ ] **Task 4: Integrate Limits into Resale Listing** (AC: 2, 4, 5)
  - [ ] Check limit before generating listing in listingService
  - [ ] Show paywall modal if limit reached
  - [ ] Display usage counter on listing screen: "1/2 listings this month"
  - [ ] Show countdown timer to next reset

- [ ] **Task 5: Create Paywall Modal** (AC: 4)
  - [ ] Create `components/PaywallModal.tsx`
  - [ ] Show feature comparison (Free vs Premium)
  - [ ] "Upgrade to Premium" CTA button
  - [ ] Link to Story 7.6 (Premium Subscription Flow)

- [ ] **Task 6: Premium User Bypass** (AC: 7)
  - [ ] Add `is_premium` check to all limit functions
  - [ ] Return unlimited for premium users
  - [ ] Display "Premium" badge in UI

- [ ] **Task 7: Testing**
  - [ ] Test AI suggestion limits
  - [ ] Test resale listing limits
  - [ ] Test reset timers
  - [ ] Test premium bypass

---

## Dev Notes

### Database Schema

```sql
CREATE TABLE user_stats (
    user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    -- AI suggestions (daily limit)
    ai_suggestions_today INT DEFAULT 0,
    ai_suggestions_reset_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '1 day'),
    -- Resale listings (monthly limit)
    resale_listings_month INT DEFAULT 0,
    resale_listings_reset_at TIMESTAMPTZ DEFAULT (DATE_TRUNC('month', NOW()) + INTERVAL '1 month'),
    -- Premium status
    is_premium BOOLEAN DEFAULT FALSE,
    premium_expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Usage Limits Constants

```typescript
const FREE_TIER_LIMITS = {
    AI_SUGGESTIONS_PER_DAY: 3,
    RESALE_LISTINGS_PER_MONTH: 2,
};
```

### Paywall Modal UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš€ Upgrade to Premium               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ You've reached your daily limit     â”‚
â”‚ (3/3 AI suggestions)                â”‚
â”‚                                     â”‚
â”‚ Premium Benefits:                   â”‚
â”‚ âœ“ Unlimited AI outfit suggestions   â”‚
â”‚ âœ“ Unlimited resale listings         â”‚
â”‚ âœ“ Advanced analytics                â”‚
â”‚ âœ“ Priority support                  â”‚
â”‚                                     â”‚
â”‚ [Upgrade to Premium - Â£4.99/month]  â”‚
â”‚                                     â”‚
â”‚ Resets in 8 hours                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Locations

| File | Path |
|------|------|
| Migration | `supabase/migrations/014_user_stats.sql` |
| Usage Service | `apps/mobile/services/usageLimitsService.ts` |
| Paywall Modal | `apps/mobile/components/PaywallModal.tsx` |
| Outfit Service | `apps/mobile/services/outfitService.ts` (update) |
| Listing Service | `apps/mobile/services/listingService.ts` (update) |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- TS check: 0 new errors (1 pre-existing in `aiCategorization.ts`)

### Completion Notes List
1. Created migration `014_usage_limits.sql` â€” adds `ai_suggestions_today`, `ai_suggestions_reset_at`, `resale_listings_month`, `resale_listings_reset_at` columns to existing `user_stats` table
2. Created `usageLimitsService.ts` â€” checks premium status via `profiles.premium_until`, checks/increments AI suggestion and resale listing counters, auto-resets when timer expires
3. Created `PaywallModal.tsx` â€” soft paywall modal with usage badge, premium benefits list, upgrade CTA (Â£4.99/month), reset countdown timer, "Maybe later" dismiss
4. Integrated limits into `useOutfitGeneration.ts` â€” checks AI suggestion limit before generating, increments counter after success, exposes `limitStatus` and `refreshLimitStatus`
5. Integrated limits into `OutfitSuggestionWidget.tsx` â€” displays usage counter badge (e.g. "2/3"), shows PaywallModal when limit reached
6. Integrated limits into `ListingGeneratorModal.tsx` â€” checks resale listing limit before generating, increments counter after success, displays usage counter in header, shows PaywallModal when blocked
7. Premium users bypass all checks (unlimited everything)

### File List

| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/014_usage_limits.sql` | Created | Usage tracking columns on user_stats |
| `apps/mobile/services/usageLimitsService.ts` | Created | Usage limits check/increment/reset service |
| `apps/mobile/components/PaywallModal.tsx` | Created | Soft paywall modal component |
| `apps/mobile/hooks/useOutfitGeneration.ts` | Modified | Added limit check before AI generation, increment after success |
| `apps/mobile/components/features/OutfitSuggestionWidget.tsx` | Modified | Added usage counter badge, PaywallModal integration |
| `apps/mobile/components/features/ListingGeneratorModal.tsx` | Modified | Added limit check before listing generation, usage counter, PaywallModal |

---

## QA Results
_(To be completed by QA Agent)_
