# Story 6.1: Style Points System

## Status

**Draft**

---

## Story

**As a** user,
**I want** to earn style points for my actions,
**so that** I feel rewarded for engaging with the app.

---

## Acceptance Criteria

1. Points earned for: upload item (+10), log outfit (+5), complete streak day (+3)
2. Bonus points for: first item of day (+2), completing challenges (+20-50)
3. Points total displayed on Profile screen
4. Points history viewable (last 30 days)
5. Animation on point earn (floating +10)
6. Database: `user_stats` table tracks total points

---

## Tasks / Subtasks

- [ ] **Task 1: Database Setup** (AC: 6, 4)
  - [ ] Create migration file `vestiaire/supabase/migrations/008_gamification_schema.sql`
  - [ ] Create `user_stats` table:
    - `user_id` (PK, ref profiles), `style_points` (int, default 0), `level` (int, default 1), `current_streak` (int, default 0), `longest_streak` (int, default 0), `last_active_date` (date)
  - [ ] Create `point_history` table (for AC 4):
    - `id` (PK), `user_id` (ref profiles), `points` (int), `action_type` (text), `created_at` (timestamptz)
  - [ ] Enable RLS on both tables (Users view own data)
  - [ ] Add trigger to initialize `user_stats` for new users (or handle in application logic)

- [ ] **Task 2: Gamification Service** (AC: 1, 2)
  - [ ] Create `vestiaire/apps/mobile/services/gamificationService.ts`
  - [ ] Implement `addPoints(userId, amount, actionType)`:
    - Transactional update: Increment `user_stats.style_points`, Insert `point_history`
    - Handle errors gracefully
  - [ ] Implement `getUserStats(userId)`
  - [ ] Implement `getPointsHistory(userId)`

- [ ] **Task 3: Backend Integration** (AC: 1, 2)
  - [ ] Update `itemsService.uploadItem` (or where upload happens) to call `addPoints(+10, 'upload')`
  - [ ] Update `wearLogService.logOutfit` to call `addPoints(+5, 'wear_log')`
  - [ ] Logic for "First item of day" bonus (+2) (check `wear_logs` count for today)

- [ ] **Task 4: Profile Screen UI** (AC: 3)
  - [ ] Modify `vestiaire/apps/mobile/app/(tabs)/profile.tsx`
  - [ ] Add `UserStatsCard` component
  - [ ] Fetch and display Total Points
  - [ ] Add "History" button

- [ ] **Task 5: Points History UI** (AC: 4)
  - [ ] Create `vestiaire/apps/mobile/components/gamification/PointsHistorySheet.tsx` (Bottom Sheet or Modal)
  - [ ] Display list of recent history (Action type, Points, Date)
  - [ ] Format dates (e.g., "Today", "Yesterday")

- [ ] **Task 6: Earn Animation** (AC: 5)
  - [ ] Create `PointsToast` component using `react-native-reanimated`
  - [ ] Trigger on point earning events
  - [ ] Visual: "+10" floating up and fading out

- [ ] **Task 7: Testing**
  - [ ] Unit Test `gamificationService` logic
  - [ ] Verify database constraints and RLS
  - [ ] Manual test: Upload item -> Verify points +10 -> Verify history entry
  - [ ] Manual test: Profile screen shows updated points

---

## Dev Notes

### Architecture references
- **User Stats Model**: Defined in `docs/architecture.md#user-stats`.
- **Service Layer**: defined in `docs/architecture.md#coding-standards`.

### Technical Decisions
- **Missing Architecture**: The `point_history` table was not explicitly defined in `docs/architecture.md` under Data Models, but is required for AC 4 ("Points history viewable"). I have added it to Task 1.
- **Service Location**: `gamificationService.ts` to encapsulate all point logic.
- **Database**: Using a new migration `008_gamification_schema.sql` to avoid modifying existing schemas.

### Testing
- Follow testing strategy in `docs/architecture.md`.
- Use `jest` for service tests.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- TypeScript check: 0 errors in modified/created files

### Completion Notes List
- Task 1: Created `008_gamification_schema.sql` with `user_stats` and `point_history` tables, RLS policies, and auto-create trigger on profile insert
- Task 2: Created `gamificationService.ts` with addPoints, getUserStats, getPointsHistory, awardUploadItem, awardWearLog, updateStreak
- Task 3: Created `PointsToast.tsx` with floating +N animation using react-native-reanimated (forwardRef with imperative handle)
- Task 4: Created `PointsHistorySheet.tsx` bottom sheet modal with action icons, labels, point badges, and relative dates
- Task 5: Added Style Points card to Profile screen with points total, level progress bar, streak badge, and history button
- Task 6: Integrated fire-and-forget point awards in confirm-item.tsx (upload) and log-wear.tsx (wear log)
- Streak logic: consecutive day tracking, streak bonus (+3), first-of-day bonus (+2)
- Level calculation uses LEVELS thresholds from @vestiaire/shared

### File List

| File | Action | Description |
|------|--------|-------------|
| `supabase/migrations/008_gamification_schema.sql` | Created | user_stats + point_history tables with RLS and auto-create trigger |
| `apps/mobile/services/gamificationService.ts` | Created | Points, stats, history, streak, and award functions |
| `apps/mobile/components/gamification/PointsToast.tsx` | Created | Floating "+N" animation component |
| `apps/mobile/components/gamification/PointsHistorySheet.tsx` | Created | Bottom sheet modal for point history |
| `apps/mobile/app/(tabs)/profile.tsx` | Modified | Added Style Points card with level progress and history button |
| `apps/mobile/app/(tabs)/confirm-item.tsx` | Modified | Added gamificationService.awardUploadItem() on item confirm |
| `apps/mobile/app/(tabs)/log-wear.tsx` | Modified | Added gamificationService.awardWearLog() on wear log |

---

## QA Results
_(To be completed by QA Agent)_
