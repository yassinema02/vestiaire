# Story 6.2: User Levels & Progression

## Status

**Draft**

---

## Story

**As a** user,
**I want** to level up as I use the app,
**so that** I feel a sense of achievement.

---

## Acceptance Criteria

1. 6 levels: Closet Rookie → Style Master
2. Levels based on item count thresholds (0, 10, 25, 50, 100, 200)
3. Level displayed prominently on Profile screen
4. Progress bar shows progress to next level
5. Level-up celebration animation when threshold reached
6. Level unlocks displayed
7. Level badge visible on user avatar

---

## Tasks / Subtasks

- [ ] **Task 1: Level Logic Implementation** (AC: 1, 2)
  - [ ] Update `vestiaire/apps/mobile/services/gamificationService.ts`
  - [ ] Add `calculateLevel(itemCount: number): number` helper
  - [ ] Add `checkAndApplyLevelUp(userId: string)` function:
    - Get current item count for user
    - Calculate new level
    - If new level > current level (from `user_stats`), update `user_stats.level`
    - Return `levelUp: boolean` and `newLevel: number`
  - [ ] Define Level Constants:
    - 1: Rookie (0)
    - 2: Novice (10)
    - 3: Intermediate (25)
    - 4: Advanced (50)
    - 5: Expert (100)
    - 6: Style Master (200)

- [ ] **Task 2: Integration with Item Upload** (AC: 5)
  - [ ] Modify `uploadItem` flow (likely in `itemsService` or a higher level orchestration)
  - [ ] Call `checkAndApplyLevelUp` after successful upload
  - [ ] If `levelUp` is true, trigger local state/event to show celebration

- [ ] **Task 3: Profile UI Updates** (AC: 3, 4, 7)
  - [ ] Create `LevelProgressCard` component:
    - Display current level name and icon
    - Progress bar: `(currentItemCount - currentLevelThreshold) / (nextLevelThreshold - currentLevelThreshold)`
    - Text: "5 more items to reach Level 3"
  - [ ] Update `ProfileHeader` (or similar) to show Level Badge on Avatar
  - [ ] Integrate `LevelProgressCard` into Profile screen

- [ ] **Task 4: Level Up Celebration** (AC: 5, 6)
  - [ ] Create `LevelUpModal` component
  - [ ] Animation: Confetti (using `react-native-confetti-cannon` or generic Lottie if available, otherwise simple `react-native-reanimated`)
  - [ ] Text: "Level Up! You are now a [Level Name]"
  - [ ] List "Unlocks" (Placeholder text for now as specific unlocks aren't defined in PRD yet, or "New Badge Slots")
  - [ ] Global state or Context to trigger this modal from anywhere (since upload might happen in different screens)

- [ ] **Task 5: Testing**
  - [ ] Unit test `calculateLevel` logic for all boundaries
  - [ ] Mock `user_stats` update
  - [ ] Manual test: Upload items until threshold is hit -> Verify Modal appears
  - [ ] Manual test: Verify Progress Bar accuracy

---

## Dev Notes

### Architecture references
- **Gamification Service**: Extends service created in Story 6.1.
- **User Stats**: Updates `level` column in `user_stats` table.

### Technical Decisions
- **Level storage**: Level is stored in DB `user_stats`, but calculation is based on `items` count. We sync them on change.
- **Trigger**: Only checking on *upload*. Deleting items generally shouldn't decrease level immediately or strictness isn't defined, so we'll implement "ratchet" logic (level only goes up) unless strict sync is requested. PRD implies "Progression", so maintaining highest achieved level is standard gamification practice.
- **Constants**: Level names borrowed from industry standards where PRD gave range "Closet Rookie -> Style Master" but didn't name 2-5 explicitly. I've improvised likely names for 2-5.

### Testing
- Jest for logic.
- Manual flow for UI.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-06 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- TypeScript check: 0 new errors in modified/created files (pre-existing errors in _layout.tsx, SwipeableOutfitCard.tsx, aiCategorization.ts unchanged)

### Completion Notes List
- Task 1: Added `getItemCount()` and `checkAndApplyLevelUp()` to gamificationService.ts — item-count-based level calculation with ratchet logic (level only goes up)
- Task 2: Created `LevelUpModal.tsx` with scaling entrance animation (react-native-reanimated), star icon rotation, level name from LEVELS constant, "Awesome!" dismiss button, auto-dismiss after 5s
- Task 3: Updated Profile screen — added indigo level badge on avatar (bottom-right circle showing level number), changed progress bar from points-based to item-count-based ("X more items to Level Y")
- Task 4: Integrated `checkAndApplyLevelUp()` in confirm-item.tsx — called after upload, shows LevelUpModal if leveled up, navigation deferred until modal dismiss

### File List

| File | Action | Description |
|------|--------|-------------|
| `apps/mobile/services/gamificationService.ts` | Modified | Added getItemCount() and checkAndApplyLevelUp() methods |
| `apps/mobile/components/gamification/LevelUpModal.tsx` | Created | Celebration modal with scaling animation, star icon, level name |
| `apps/mobile/app/(tabs)/profile.tsx` | Modified | Added level badge on avatar, item-count-based progress bar |
| `apps/mobile/app/(tabs)/confirm-item.tsx` | Modified | Integrated level-up check after upload, shows LevelUpModal |

---

## QA Results
_(To be completed by QA Agent)_
