# Story 6.6: Closet Safari Challenge (Onboarding)

## Status

**Implemented**

---

## Story

**As a** new user,
**I want** to participate in the "Closet Safari" challenge,
**so that** I'm motivated to quickly build my wardrobe.

---

## Acceptance Criteria

1. Challenge offered after signup: "Upload 20 items in 7 days"
2. Progress tracker: "12/20 items, 4 days remaining"
3. Daily reminder notifications during challenge
4. Reward: 1 month Premium free upon completion
5. Challenge badge unlocked for participation
6. Challenge can be skipped
7. One-time challenge, not repeatable

---

## Tasks / Subtasks

- [ ] **Task 1: Database Schema** (AC: 1, 7)
  - [ ] Create migration `vestiaire/supabase/migrations/012_challenges_schema.sql`
  - [ ] Create `user_challenges` table:
    - `id` (UUID PK)
    - `user_id` (Ref profiles)
    - `challenge_type` (TEXT: 'closet_safari')
    - `status` (TEXT: 'active', 'completed', 'skipped', 'expired')
    - `progress` (INTEGER: current item count)
    - `target` (INTEGER: 20)
    - `started_at` (TIMESTAMPTZ)
    - `expires_at` (TIMESTAMPTZ)
    - `completed_at` (TIMESTAMPTZ)
  - [ ] Enable RLS.

- [ ] **Task 2: Challenge Logic** (AC: 1, 4, 6)
  - [ ] Update `gamificationService.ts`:
  - [ ] `startChallenge(userId, type)`: Creates entry with 7 day expiry.
  - [ ] `updateChallengeProgress(userId, type)`:
    - Called on item upload.
    - Increment progress.
    - If `progress >= target`:
      - Set status = 'completed'
      - Trigger Reward (Premium + Badge)
  - [ ] `skipChallenge(userId, type)`: Set status = 'skipped'.

- [ ] **Task 3: Onboarding Integration** (AC: 1)
  - [ ] Update `apps/mobile/app/(auth)/sign-up.tsx` or post-signup flow.
  - [ ] Show `ChallengeInviteModal` after successful registration.
  - [ ] "Accept" -> `startChallenge` -> Navigate to Home.
  - [ ] "Skip" -> `skipChallenge` -> Navigate to Home.

- [ ] **Task 4: UI Implementation** (AC: 2)
  - [ ] Create `ChallengeTrackerCard` (Home Screen).
  - [ ] Show Progress Bar (X/20).
  - [ ] Show Countdown ("3 days left").
  - [ ] Hide if status is not 'active'.

- [ ] **Task 5: Notifications (Local)** (AC: 3)
  - [ ] Schedule local notifications when starting challenge:
    - Day 1: "Keep going! 6 days left."
    - Day 3: "Halfway there?"
    - Day 7: "Last chance!"
  - [ ] Cancel notifications if completed/skipped.

- [ ] **Task 6: Rewards** (AC: 4, 5)
  - [ ] If completed:
    - Update `profiles.premium_until` (+30 days).
    - Call `addBadge` (Story 6.4) for "Safari Explorer" (New Badge).

- [ ] **Task 7: Testing**
  - [ ] Unit Test `updateChallengeProgress` logic.
  - [ ] Manual Test: Signup -> Accept -> Upload items -> Verify Progress -> Verify Completion.

---

## Dev Notes

### Architecture references
- **New Table**: `user_challenges` to support future challenges beyond just onboarding.
- **Premium**: Directly updates `profiles` table.

### Technical Decisions
- **Timer**: Relies on `expires_at` timestamp.
- **Notifications**: Local notifications scheduled at start time (easiest for MVP vs server cron).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Initial story draft | Bob (SM) |
